<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>送迎バス ログイン</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:#f1f5f9;}
    .wrap{max-width:400px;margin:40px auto;padding:24px;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(15,23,42,.12);}
    h1{text-align:center;font-size:20px;margin-bottom:16px;}
    label{display:block;font-size:14px;margin:8px 0 4px;}
    input{width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1;box-sizing:border-box;}
    button{width:100%;margin-top:16px;padding:10px;border:none;border-radius:999px;background:#2563eb;color:#fff;font-size:15px;cursor:pointer;}
    button:disabled{background:#9ca3af;cursor:default;}
    .msg{margin-top:8px;font-size:13px;color:#ef4444;min-height:1.2em;}
    .link{margin-top:12px;font-size:13px;text-align:center;}
    a{color:#2563eb;text-decoration:none;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>送迎バス ログイン</h1>
  <form id="loginForm">
    <label for="email">メールアドレス</label>
    <input id="email" type="email" required>
    <label for="password">パスワード</label>
    <input id="password" type="password" required>
    <button id="btnLogin" type="submit">ログイン</button>
    <div id="msg" class="msg"></div>
  </form>
  <div class="link">
    アカウントをお持ちでない方は
    <a href="user-register.html">新規登録</a>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
    authDomain: "the-bus-94fe3.firebaseapp.com",
    projectId: "the-bus-94fe3",
    storageBucket: "the-bus-94fe3.firebasestorage.app",
    messagingSenderId: "782387450057",
    appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const form = document.getElementById("loginForm");
  const msgEl = document.getElementById("msg");
  const btn  = document.getElementById("btnLogin");

  setPersistence(auth, browserLocalPersistence).catch(console.error);

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    msgEl.textContent = "";
    btn.disabled = true;

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      const uid  = cred.user.uid;

      const qAcc = query(
        collection(db,"accounts"),
        where("uid","==",uid)
      );
      const snap = await getDocs(qAcc);

      if (snap.empty) {
        await signOut(auth);
        throw new Error("このアカウントは利用者登録が完了していません。");
      }
      const acc = snap.docs[0].data();
      if (acc.userType !== "basic") {
        await signOut(auth);
        throw new Error("このアカウントは一般利用者用ではありません。");
      }

      window.location.href = "user-map.html";
    } catch (err) {
      console.error(err);
      msgEl.textContent = err.message || "ログインに失敗しました。";
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
