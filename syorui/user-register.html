<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>送迎バス 利用者登録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:#f1f5f9;}
    .wrap{max-width:420px;margin:40px auto;padding:24px;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(15,23,42,.12);}
    h1{text-align:center;font-size:20px;margin-bottom:16px;}
    label{display:block;font-size:14px;margin:8px 0 4px;}
    input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1;box-sizing:border-box;}
    button{width:100%;margin-top:16px;padding:10px;border:none;border-radius:999px;background:#16a34a;color:#fff;font-size:15px;cursor:pointer;}
    button:disabled{background:#9ca3af;cursor:default;}
    .msg{margin-top:8px;font-size:13px;color:#ef4444;min-height:1.2em;}
    .link{margin-top:12px;font-size:13px;text-align:center;}
    a{color:#2563eb;text-decoration:none;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>利用者登録</h1>
  <form id="registerForm">
    <label for="name">お名前</label>
    <input id="name" type="text" required>

    <label for="email">メールアドレス</label>
    <input id="email" type="email" required>

    <label for="password">パスワード</label>
    <input id="password" type="password" required>

    <label for="facility">利用する施設（行き先）</label>
    <select id="facility" required>
      <option value="">読み込み中...</option>
    </select>

    <button id="btnRegister" type="submit">登録</button>
    <div id="msg" class="msg"></div>
  </form>
  <div class="link">
    すでにアカウントをお持ちの方は
    <a href="user-login.html">ログイン</a>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    setPersistence,
    browserLocalPersistence,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    collection,
    getDocs,
    addDoc,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
    authDomain: "the-bus-94fe3.firebaseapp.com",
    projectId: "the-bus-94fe3",
    storageBucket: "the-bus-94fe3.firebasestorage.app",
    messagingSenderId: "782387450057",
    appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  setPersistence(auth, browserLocalPersistence).catch(console.error);

  const facilitySelect = document.getElementById("facility");
  const form = document.getElementById("registerForm");
  const msgEl = document.getElementById("msg");
  const btn   = document.getElementById("btnRegister");

  async function loadFacilities(){
    try {
      const qRoutes = query(
        collection(db,"routes"),
        orderBy("clientName","asc")
      );
      const snap = await getDocs(qRoutes);
      const set = new Set();
      snap.forEach(d=>{
        const c = d.data().clientName;
        if (c) set.add(c);
      });

      facilitySelect.innerHTML = "";
      if (set.size === 0) {
        facilitySelect.innerHTML = '<option value="">登録可能な施設がありません</option>';
        facilitySelect.disabled = true;
        btn.disabled = true;
        return;
      }
      facilitySelect.appendChild(new Option("選択してください",""));
      [...set].sort().forEach(name=>{
        facilitySelect.appendChild(new Option(name,name));
      });
    } catch(e){
      console.error(e);
      facilitySelect.innerHTML = '<option value="">読み込みに失敗しました</option>';
    }
  }
  loadFacilities();

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    msgEl.textContent = "";
    btn.disabled = true;

    const name     = document.getElementById("name").value.trim();
    const email    = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const facility = facilitySelect.value;

    if (!facility) {
      msgEl.textContent = "施設を選択してください。";
      btn.disabled = false;
      return;
    }

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const uid  = cred.user.uid;

      await addDoc(collection(db,"accounts"),{
        uid,
        email,
        name,
        userType: "basic",
        facilityName: facility,
        createdAt: new Date()
      });

      await signOut(auth);
      alert("登録が完了しました。ログインしてください。");
      window.location.href = "user-login.html";
    } catch (err) {
      console.error(err);
      msgEl.textContent = err.message || "登録に失敗しました。";
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
