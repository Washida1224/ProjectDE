<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‡ãƒ¢å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ç™»éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { font-size: 1.2rem; }
    button {
      padding: 10px 20px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 10px;
    }
    button:hover { background: #0d47a1; }
    #log { margin-top: 10px; font-size: 0.9rem; }
  </style>
</head>
<body>

  <h1>ãƒ‡ãƒ¢å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ç™»éŒ²</h1>

  <p>ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç”¨ã«ã€æŒ‡å®šã—ãŸæœˆã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ <strong>workRecords / {uid}</strong> ã«ä½œæˆã—ã¾ã™ã€‚</p>

  <div>
    å¯¾è±¡å¹´æœˆï¼š
    <input type="month" id="monthPicker">
  </div>

  <button id="insertBtn">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹</button>

  <p id="log"></p>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
      authDomain: "the-bus-94fe3.firebaseapp.com",
      projectId: "the-bus-94fe3",
      storageBucket: "the-bus-94fe3.firebasestorage.app",
      messagingSenderId: "782387450057",
      appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
      measurementId: "G-D9627JEYQ6"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db   = firebase.firestore();

    const monthPicker = document.getElementById('monthPicker');
    const insertBtn   = document.getElementById('insertBtn');
    const logEl       = document.getElementById('log');

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (!user) {
        logEl.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
        insertBtn.disabled = true;
        return;
      }
      currentUser = user;
      logEl.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email || user.uid}`;
    });

    function pad2(num) {
      return String(num).padStart(2, '0');
    }

    // baseHour Â± variation æ™‚é–“ã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
    function getRandomTime(baseHour, variation) {
      const h = baseHour + Math.floor(Math.random() * variation * 2 - variation);
      const m = Math.random() < 0.5 ? "00" : "30";
      return `${pad2(h)}:${m}`;
    }

    function calcMinutes(dateStr, startStr, endStr) {
      const start = new Date(dateStr + ' ' + startStr);
      const end   = new Date(dateStr + ' ' + endStr);
      return (end - start) / 60000;
    }

    insertBtn.addEventListener('click', async () => {
      if (!currentUser) return;

      const monthValue = monthPicker.value;
      if (!monthValue) {
        alert("å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
      const [year, month] = monthValue.split('-').map(n => parseInt(n, 10));
      const daysInMonth  = new Date(year, month, 0).getDate();

      logEl.textContent = "æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";

      const docRef = db.collection('workRecords').doc(currentUser.uid);
      const snap   = await docRef.get();
      let records  = {};
      if (snap.exists && snap.data().records) {
        records = snap.data().records;
      }

      let count = 0;

      logEl.textContent = "ç™»éŒ²ä¸­...";

      for (let day = 1; day <= daysInMonth; day++) {
        // åœŸæ—¥ãªã©ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§ä¼‘ã¿ã«ã™ã‚‹ï¼ˆ25%ãã‚‰ã„ä¼‘ã¿ï¼‰
        if (Math.random() < 0.25) continue;

        const dateStr   = `${year}-${pad2(month)}-${pad2(day)}`;
        const startTime = getRandomTime(8, 1);   // 7ã€œ9æ™‚ãã‚‰ã„
        const endTime   = getRandomTime(18, 1);  // 17ã€œ19æ™‚ãã‚‰ã„

        const dutyMinutes   = calcMinutes(dateStr, startTime, endTime);
        const breakMinutes  = Math.random() < 0.3 ? 90 : 60; // 60 or 90åˆ†
        const workMinutes   = dutyMinutes - breakMinutes;

        // uidãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†… records[dateStr] ã«ä¿å­˜
        records[dateStr] = {
          startTime,
          endTime,
          breakMinutes,
          dutyMinutes,
          workMinutes
        };
        count++;
      }

      await docRef.set(
        {
          records,
          updatedAt: firebase.firestore.Timestamp.now()
        },
        { merge: true }
      );

      logEl.textContent = `${count} ä»¶ã®ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ï¼ˆworkRecords/${currentUser.uid}ï¼‰`;
      alert("è¿½åŠ å®Œäº†ï¼å‹¤å‹™æ™‚é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ ğŸ‰");
    });
  </script>

</body>
</html>
