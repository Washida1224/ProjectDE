<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>デモ勤怠データ登録（問題含む）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { font-size: 1.2rem; }
    button {
      padding: 10px 20px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 10px;
    }
    button:hover { background: #0d47a1; }
    #log { margin-top: 10px; font-size: 0.9rem; }
  </style>
</head>
<body>

  <h1>デモ勤怠データ登録（意図的に問題を含む）</h1>

  <p>
    ログイン中ユーザーの <strong>workRecords / {uid}</strong> に、<br>
    通常の勤務データ + 一部「拘束時間超過」「休息不足」の日を含むデモデータを登録します。
  </p>

  <div>
    対象年月：
    <input type="month" id="monthPicker">
  </div>

  <button id="insertBtn">デモデータを登録する</button>

  <p id="log"></p>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
      authDomain: "the-bus-94fe3.firebaseapp.com",
      projectId: "the-bus-94fe3",
      storageBucket: "the-bus-94fe3.firebasestorage.app",
      messagingSenderId: "782387450057",
      appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
      measurementId: "G-D9627JEYQ6"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db   = firebase.firestore();

    const monthPicker = document.getElementById('monthPicker');
    const insertBtn   = document.getElementById('insertBtn');
    const logEl       = document.getElementById('log');

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (!user) {
        logEl.textContent = "ログインしてください。";
        insertBtn.disabled = true;
        return;
      }
      currentUser = user;
      logEl.textContent = `ログイン中: ${user.email || user.uid}`;
    });

    function pad2(num) {
      return String(num).padStart(2, '0');
    }

    function calcMinutes(dateStr, startStr, endStr) {
      const start = new Date(dateStr + ' ' + startStr);
      const end   = new Date(dateStr + ' ' + endStr);
      return (end - start) / 60000;
    }

    insertBtn.addEventListener('click', async () => {
      if (!currentUser) return;

      const monthValue = monthPicker.value;
      if (!monthValue) {
        alert("年月を選択してください");
        return;
      }

      const [year, month] = monthValue.split('-').map(n => parseInt(n, 10));
      const daysInMonth  = new Date(year, month, 0).getDate();

      logEl.textContent = "既存データ取得中...";

      const docRef = db.collection('workRecords').doc(currentUser.uid);
      const snap   = await docRef.get();
      let records  = {};
      if (snap.exists && snap.data().records) {
        records = snap.data().records;
      }

      logEl.textContent = "登録中...";

      // 特別な「問題あり」日（day番号）
      const specialDays = {
        10: 'warningDuty',      // 拘束14h → 黄色
        15: 'dangerDuty',       // 拘束16h → 赤
        20: 'beforeRest',       // 23:00 まで勤務（翌日の休息不足の前日）
        21: 'afterRestDanger',  // 休息8h → 赤
      };

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${pad2(month)}-${pad2(day)}`;
        const type = specialDays[day];

        // 特別指定日以外は、25%くらい休日にする
        if (!type && Math.random() < 0.25) continue;

        let startTime, endTime, breakMinutes = 60;

        if (type === 'warningDuty') {
          // 10日：7:00〜21:00 → 14時間拘束 → 黄色（13h超〜15h以内）
          startTime = '07:00';
          endTime   = '21:00';
        } else if (type === 'dangerDuty') {
          // 15日：6:00〜22:00 → 16時間拘束 → 赤（15h超）
          startTime = '06:00';
          endTime   = '22:00';
        } else if (type === 'beforeRest') {
          // 20日：10:00〜23:00 → 翌日の休息を短くするため遅くまで勤務
          startTime = '10:00';
          endTime   = '23:00';
        } else if (type === 'afterRestDanger') {
          // 21日：7:00〜15:00 → 前日23:00終了 → 休息8時間 → 赤
          startTime = '07:00';
          endTime   = '15:00';
        } else {
          // 通常日：8:00〜18:00 前後で適当にぶらす
          const baseStartHour = 8 + (Math.random() < 0.5 ? 0 : 1); // 8 or 9
          const baseEndHour   = 18 + (Math.random() < 0.5 ? 0 : 1); // 18 or 19
          startTime = `${pad2(baseStartHour)}:00`;
          endTime   = `${pad2(baseEndHour)}:00`;
        }

        const dutyMinutes = calcMinutes(dateStr, startTime, endTime);
        const workMinutes = dutyMinutes - breakMinutes;

        records[dateStr] = {
          startTime,
          endTime,
          breakMinutes,
          dutyMinutes,
          workMinutes
        };
      }

      await docRef.set(
        {
          records,
          updatedAt: firebase.firestore.Timestamp.now()
        },
        { merge: true }
      );

      logEl.textContent = `デモデータを登録しました！（workRecords/${currentUser.uid}）`;
      alert("追加完了！カレンダーページを開くと、黄色・赤のセルが混ざって表示されるはずです。");
    });
  </script>

</body>
</html>
