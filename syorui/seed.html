<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>routes へ湘17ルートを投入</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;margin:0;background:#f8fafc;color:#111827}
  main{max-width:680px;margin:24px auto;padding:16px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
  h1{font-size:1.1rem;margin:0 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;flex:1}
  button{padding:12px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .note{font-size:12px;color:#6b7280}
</style>
</head>
<body>
<main>
  <h1>routes に「湘17：湘南台駅西口 → 文教大学」を追加</h1>
  <p class="mono" id="who">未ログイン</p>

  <div class="row">
    <button id="btnSignIn">Googleでログイン</button>
  </div>

  <div class="row">
    <input id="routeName" type="text" value="湘17：湘南台駅西口→文教大学" />
  </div>
  <div class="row">
    <label class="note">サービス日（JST）</label>
    <input id="serviceDate" type="date" />
  </div>
  <div class="row">
    <label class="note">開始時刻（JST）</label>
    <input id="startTime" type="time" value="07:30" />
    <label class="note">終了時刻（JST）</label>
    <input id="endTime" type="time" value="09:00" />
  </div>
  <div class="row">
    <input id="clientName" type="text" placeholder="顧客名" value="ABC学園" />
    <input id="driverName" type="text" placeholder="ドライバー名（任意）" />
    <input id="vehicleId" type="text" placeholder="車両ID" value="bus-001" />
  </div>

  <div class="row">
    <button id="btnPush">投入する</button>
  </div>

  <p class="note">
    ・ログイン中ユーザーの <strong>uid</strong> を routes ドキュメントの <strong>uid</strong> フィールドに保存します（旧 driverId は使いません）。<br>
    ・各バス停の <strong>ETA</strong> は開始時刻から区間ごとの目安分（下記）を自動で加算して設定します。<br>
    ・必要なら後から Firestore 上で時刻だけ手直しできます。
  </p>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Firebase 設定（提供値）
  const firebaseConfig = {
    apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
    authDomain: "the-bus-94fe3.firebaseapp.com",
    projectId: "the-bus-94fe3",
    storageBucket: "the-bus-94fe3.firebasestorage.app",
    messagingSenderId: "782387450057",
    appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
    measurementId: "G-D9627JEYQ6"
  };

  // 湘17 停留所（名称だけ。位置は任意で routes には不要）
  const STOP_NAMES = [
    "湘南台駅西口",
    "湘南台住宅前",
    "桐ヶ谷（藤沢市）",
    "南桐原",
    "石川山田",
    "和泉橋",
    "寿照寺前",
    "田方（藤沢市）",
    "矢尻（藤沢市）",
    "南原（藤沢市）",
    "湘南ライフタウン",
    "小出一本松",
    "大辻（藤沢市）",
    "小出小学校前",
    "芹沢入口",
    "文教大学"
  ];

  // 区間ごとの目安分（適当なテスト値：細かく調整可）
  // 配列長は STOP_NAMES.length-1 に揃える
  const SEGMENT_MIN = [3,3,4,3,4,3,4,4,3,5,4,3,4,5,6];

  // DOM
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const who = document.getElementById('who');
  const btnSignIn = document.getElementById('btnSignIn');
  const btnPush = document.getElementById('btnPush');
  const routeNameEl = document.getElementById('routeName');
  const serviceDateEl = document.getElementById('serviceDate');
  const startTimeEl = document.getElementById('startTime');
  const endTimeEl = document.getElementById('endTime');
  const clientNameEl = document.getElementById('clientName');
  const driverNameEl = document.getElementById('driverName');
  const vehicleIdEl = document.getElementById('vehicleId');

  // 既定で今日の日付
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  serviceDateEl.value = `${yyyy}-${mm}-${dd}`;

  onAuthStateChanged(auth, (u)=>{
    who.textContent = u ? `ログイン：${u.email || u.uid}` : '未ログイン';
  });

  btnSignIn.onclick = async ()=>{ await signInWithPopup(auth, new GoogleAuthProvider()); };

  function tsFromLocal(dateStr, timeStr){
    // dateStr: 'YYYY-MM-DD', timeStr: 'HH:MM'
    const [Y,M,D] = dateStr.split('-').map(n=>parseInt(n,10));
    const [h,m] = timeStr.split(':').map(n=>parseInt(n,10));
    return new Date(Y, M-1, D, h, m, 0, 0);
  }

  btnPush.onclick = async ()=>{
    const u = auth.currentUser;
    if(!u){ alert('先にログインしてください'); return; }

    const uid = u.uid;
    const routeName = routeNameEl.value.trim() || '湘17：湘南台駅西口→文教大学';
    const clientName = clientNameEl.value.trim() || '';
    const driverName = driverNameEl.value.trim() || '';
    const vehicleId = vehicleIdEl.value.trim() || 'bus-001';
    const serviceDate = serviceDateEl.value; // YYYY-MM-DD
    const start = tsFromLocal(serviceDate, startTimeEl.value || '07:30');
    const end   = tsFromLocal(serviceDate, endTimeEl.value   || '09:00');

    // stops: ETA を積み上げ
    const stops = [];
    let t = new Date(start.getTime());
    for(let i=0;i<STOP_NAMES.length;i++){
      if(i>0){ t = new Date(t.getTime() + SEGMENT_MIN[i-1]*60*1000); }
      stops.push({ name: STOP_NAMES[i], eta: t });
    }

    const routeId = `route-${serviceDate.replace(/-/g,'')}-${Math.random().toString(36).slice(2,6)}`;

    const payload = {
      routeId,
      routeName,
      clientName,
      uid,                 // ← driverId の代わりに uid を保存
      driverName,
      vehicleId,
      serviceDate: new Date(serviceDate + 'T00:00:00'),  // 保管用
      startTime:   start,
      endTime:     end,
      stops,
      createdAt:   serverTimestamp(),
      updatedAt:   serverTimestamp()
    };

    await addDoc(collection(db, 'routes'), payload);

    alert('routes に湘17ルートを追加しました！\nadmin/driver から参照できます。');
  };
</script>
</body>
</html>