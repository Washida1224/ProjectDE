<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>運転日報フォーム</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="form-container">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <h1 class="form-title" style="margin:0;">運転日報</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <span id="loginStatus" style="font-size:12px; color:#555;">未ログイン</span>
        <button id="btnLogin" type="button">Googleでログイン</button>
        <button id="btnLogout" type="button" style="display:none;">ログアウト</button>
        <input id="reportDate" type="date" />
        <button id="btnAutofill" type="button">この日で自動入力</button>
      </div>
    </div>

    <form action="YOUR_BACKEND_SCRIPT.php" method="post" class="grid-form" id="reportForm">

      <!-- 日付 -->
      <div class="grid-cell label-cell" style="grid-column: 2 / span 1; grid-row: 3;">日付</div>
      <div class="grid-cell input-cell" style="grid-column: 3 / span 9; grid-row: 3;">
        <input type="number" name="C3" > 年
        <input type="number" name="F3" > 月
        <input type="number" name="I3" > 日
        <input type="text" name="K3" placeholder="　　曜日">
      </div>

      <!-- 運転者 -->
      <div class="grid-cell label-cell" style="grid-column: 2 / span 3; grid-row: 4;">運転者</div>
      <div class="grid-cell input-cell" style="grid-column: 5 / span 7; grid-row: 4;">
        <input type="text" id="driver-name" name="E4">
      </div>

      <!-- 入出庫メーター -->
      <div class="grid-cell label-cell" style="grid-column: 2 / span 3; grid-row: 5;">入庫時メーター</div>
      <div class="grid-cell input-cell" style="grid-column: 5 / span 7; grid-row: 5;">
        <input type="number" name="E5" placeholder="km">
      </div>
      <div class="grid-cell label-cell" style="grid-column: 2 / span 3; grid-row: 6;">出庫時メーター</div>
      <div class="grid-cell input-cell" style="grid-column: 5 / span 7; grid-row: 6;">
        <input type="number" name="E6" placeholder="km">
      </div>

      <!-- 走行距離 -->
      <div class="grid-cell label-cell" style="grid-column: 2 / span 3; grid-row: 7;">走行距離</div>
      <div class="grid-cell input-cell" style="grid-column: 5 / span 7; grid-row: 7;">
        <input type="number" name="E7" placeholder="km">
      </div>

      <!-- 右側：車両・天候・時間 -->
      <div class="grid-cell label-cell" style="grid-column: 13 / span 3; grid-row: 3;">車両番号</div>
      <div class="grid-cell input-cell" style="grid-column: 16 / span 10; grid-row: 3;">
        <input type="text" id="vehicle-number" name="P3">
      </div>

      <div class="grid-cell label-cell" style="grid-column: 13 / span 3; grid-row: 4;">天候</div>
      <div class="grid-cell input-cell" style="grid-column: 16 / span 10; grid-row: 4;">
        <input type="text" id="weather" name="P4">
      </div>
      
      <div class="grid-cell label-cell" style="grid-column: 13 / span 3; grid-row: 5 / span 2;">時間</div>
      <div class="grid-cell input-cell" style="grid-column: 16 / span 10; grid-row: 5;">
        入庫 <input type="number" name="P5" min="0" max="23"> 時 <input type="number" name="T5" min="0" max="59"> 分
      </div>
      <div class="grid-cell input-cell" style="grid-column: 16 / span 10; grid-row: 6;">
        出庫 <input type="number" name="P6" min="0" max="23"> 時 <input type="number" name="T6" min="0" max="59"> 分
      </div>

      <div class="grid-cell label-cell" style="grid-column: 13 / span 3; grid-row: 7;">給油</div>
      <div class="grid-cell input-cell" style="grid-column: 16 / span 10; grid-row: 7;">
        <input type="number" name="P7" step="0.1" placeholder="ℓ">
      </div>

      <!-- 以下、既存の点検・記録UIはそのまま -->
      <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 8;">運転前点検</div>
      <div class="grid-cell centered-cell" style="grid-column: 1 / span 7; grid-row: 9;">アルコールチェック <input type="text" name="H9" class="small-input"> mg/l</div>
      <div class="grid-cell centered-cell" style="grid-column: 8 / span 4; grid-row: 9;"><label><input type="checkbox" name="N9"> 清掃</label></div>
      <div class="grid-cell centered-cell" style="grid-column: 12 / span 3; grid-row: 9;"><label><input type="checkbox" name="R9"> 傷</label></div>
      <div class="grid-cell centered-cell" style="grid-column: 1 / span 7; grid-row: 10;"><label><input type="checkbox" name="G10"> 免許証</label></div>
      <div class="grid-cell centered-cell" style="grid-column: 8 / span 4; grid-row: 10;"><label><input type="checkbox" name="K10"> 服装</label></div>
      <div class="grid-cell centered-cell" style="grid-column: 12 / span 3; grid-row: 10;"><label><input type="checkbox" name="N10"> 名札</label></div>
      <div class="grid-cell centered-cell" style="grid-column: 15 / span 3; grid-row: 10;"><label><input type="checkbox" name="Q10"> 体調</label></div>

      <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 11;">車両点検項目</div>
      <div class="grid-cell header-cell" style="grid-column: 1 / span 8; grid-row: 12;">項目</div>
      <div class="grid-cell header-cell" style="grid-column: 9 / span 2; grid-row: 12;">判定</div>
      <div class="grid-cell header-cell" style="grid-column: 11 / span 2; grid-row: 12;">対応</div>
      <div class="grid-cell header-cell" style="grid-column: 13 / span 8; grid-row: 12;">項目</div>
      <div class="grid-cell header-cell" style="grid-column: 21 / span 2; grid-row: 12;">判定</div>
      <div class="grid-cell header-cell" style="grid-column: 23 / span 4; grid-row: 12;">対応</div>

      <div class="grid-cell" style="grid-column: 1 / -1; grid-row: 21;">運行記録</div>
      <div class="grid-cell header-cell" style="grid-column: 1 / span 5; grid-row: 22;">便名</div>
      <div class="grid-cell header-cell" style="grid-column: 6 / span 6; grid-row: 22;">出発時間</div>
      <div class="grid-cell header-cell" style="grid-column: 12 / span 6; grid-row: 22;">到着時間</div>
      <div class="grid-cell header-cell" style="grid-column: 18 / span 9; grid-row: 22;">乗車人数</div>

      <div class="grid-cell subgrid-container" id="trip-log-container" style="grid-column: 1 / -1; grid-row: 23 / span 8;"></div>
      <div class="grid-cell" style="grid-column: 1 / -1; grid-row: 31;"><button type="button" id="add-trip-button">運行を追加</button></div>

      <div class="grid-cell" style="grid-column: 1 / -1; grid-row: 32;">運転中の特記事項</div>
      <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 33 / span 2;"><textarea name="A34"></textarea></div>

      <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 35;">終業点検</div>
      <div class="grid-cell centered-cell" style="grid-column: 1 / span 6; grid-row: 36;"><label><input type="checkbox" name="F37"> 車両異常</label></div>
      <div class="grid-cell centered-cell" style="grid-column: 7 / span 6; grid-row: 36;"><label><input type="checkbox" name="L37"> 交通事故</label></div>
      <div class="grid-cell centered-cell" style="grid-column: 13 / span 6; grid-row: 36;"><label><input type="checkbox" name="Q37"> 忘れ物</label></div>
      <div class="grid-cell centered-cell" style="grid-column: 19 / span 8; grid-row: 36;"><label><input type="checkbox" name="W37"> 傷</label></div>

      <div class="grid-cell" style="grid-column: 1 / -1; grid-row: 37;">連絡事項・備考</div>
      <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 38 / span 3;"><textarea name="A41"></textarea></div>
      
      <div class="grid-cell" style="grid-column: 1 / -1; grid-row: 41;">
        <button type="submit" class="submit-button">報告書を作成してダウンロード</button>
      </div>
    </form>
  </div>

  <!-- Firebaseロジック -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
      authDomain: "the-bus-94fe3.firebaseapp.com",
      projectId: "the-bus-94fe3",
      storageBucket: "the-bus-94fe3.firebasestorage.app",
      messagingSenderId: "782387450057",
      appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- UI refs
    const loginStatus = document.getElementById('loginStatus');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const reportDate = document.getElementById('reportDate');
    const btnAutofill = document.getElementById('btnAutofill');
    const form = document.getElementById('reportForm');
    const tripLog = document.getElementById('trip-log-container');

    // ---- Helpers
    const setByName = (name, value)=>{ const el = form.querySelector(`[name="${name}"]`); if(el) el.value = value ?? ''; };
    const toJST = d => new Date(d.getTime() + 9*60*60*1000);
    const pad = n => String(n).padStart(2,'0');
    const weekday = ["日","月","火","水","木","金","土"];

    function setDateFields(d){
      const j = toJST(d);
      setByName('C3', j.getUTCFullYear());
      setByName('F3', j.getUTCMonth()+1);
      setByName('I3', j.getUTCDate());
      setByName('K3', ` ${weekday[j.getUTCDay()]}曜`);
    }

    function setInOutTimes(first, last){
      // 入庫：P5/T5（時/分） ← 最後（last）
      // 出庫：P6/T6 ← 最初（first）
      if(first){
        const fj = toJST(first);
        setByName('P6', fj.getUTCHours());
        setByName('T6', fj.getUTCMinutes());
      }
      if(last){
        const lj = toJST(last);
        setByName('P5', lj.getUTCHours());
        setByName('T5', lj.getUTCMinutes());
      }
    }

    function addTripRow({routeName, startTime, endTime}){
      const row = document.createElement('div');
      row.className = 'subgrid-row';
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr 1fr 1fr 1fr';
      row.style.gap = '8px';
      row.style.marginBottom = '8px';

      const f1 = document.createElement('input'); f1.type='text';  f1.value = routeName || '';
      const f2 = document.createElement('input'); f2.type='time';  f2.value = startTime || '';
      const f3 = document.createElement('input'); f3.type='time';  f3.value = endTime || '';
      const f4 = document.createElement('input'); f4.type='number'; f4.placeholder='人数';

      row.appendChild(f1); row.appendChild(f2); row.appendChild(f3); row.appendChild(f4);
      tripLog.appendChild(row);
    }
    function clearTripRows(){ tripLog.innerHTML = ''; }

    // 距離計算（ハバースイン）
    const R=6371000, toRad=d=>d*Math.PI/180;
    function haversine(a,b){
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }
    function calcDistanceKm(points){
      let m=0;
      for(let i=1;i<points.length;i++){
        m += haversine(points[i-1], points[i]);
      }
      return m/1000;
    }

    // ---- Auth
    onAuthStateChanged(auth, async (u)=>{
      if(u){
        loginStatus.textContent = `ログイン中：${u.email || u.uid}`;
        btnLogin.style.display = 'none';
        btnLogout.style.display = '';
        // アカウント名で運転者を自動セット
        const qAcc = query(collection(db,'accounts'), where('uid','==',u.uid));
        const sAcc = await getDocs(qAcc);
        const name = sAcc.empty ? '' : (sAcc.docs[0].data().name || '');
        if(name) document.getElementById('driver-name').value = name;
      }else{
        loginStatus.textContent = '未ログイン';
        btnLogin.style.display = '';
        btnLogout.style.display = 'none';
      }
    });

    btnLogin.onclick = async()=>{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };
    btnLogout.onclick = async()=>{ await signOut(auth); };

    // ---- 自動入力
    btnAutofill.onclick = async ()=>{
      const u = auth.currentUser;
      if(!u){ alert('先にログインしてください'); return; }
      if(!reportDate.value){ alert('日付を選択してください'); return; }

      const dateStr = reportDate.value;          // YYYY-MM-DD
      const d0 = new Date(`${dateStr}T00:00:00+09:00`);
      const d1 = new Date(`${dateStr}T23:59:59.999+09:00`);
      setDateFields(d0);

      // 1) positions から最初/最後・距離（自動計算）
      const posCol = collection(db, 'drivers', u.uid, 'positions');
      const qPos = query(posCol, where('serverAt','>=', d0), where('serverAt','<=', d1), orderBy('serverAt','asc'));
      const sPos = await getDocs(qPos);

      const pts = [];
      let firstTs=null, lastTs=null;
      sPos.forEach(docSnap=>{
        const x = docSnap.data();
        const t = x.serverAt?.toDate ? x.serverAt.toDate() : (x.serverAt ? new Date(x.serverAt) : null);
        if(t){
          if(!firstTs) firstTs = t;
          lastTs = t;
        }
        // 精度フィルタ: accuracy<=80m を採用（なければ採用）
        if(typeof x.lat==='number' && typeof x.lng==='number' &&
           (x.accuracy==null || x.accuracy<=80)){
          pts.push({lat:x.lat, lng:x.lng});
        }
      });

      setInOutTimes(firstTs, lastTs);

      // 距離を自動計算（km, 小数2桁）
      const km = (pts.length>=2) ? calcDistanceKm(pts) : 0;
      setByName('E7', km.toFixed(2));

      // 2) 運行記録：routes(uid==自分 & serviceDate==dateStr)
      clearTripRows();
      const qRoutes = query(
        collection(db,'routes'),
        where('uid','==', u.uid),
        where('serviceDate','==', new Date(`${dateStr}T00:00:00+09:00`))
      );
      const sRoutes = await getDocs(qRoutes);

      const rows = [];
      sRoutes.forEach(r=>{
        const d = r.data();
        const st = d.startTime?.toDate ? d.startTime.toDate() : (d.startTime ? new Date(d.startTime) : null);
        const et = d.endTime?.toDate ? d.endTime.toDate() : (d.endTime ? new Date(d.endTime) : null);
        const stJ = st ? toJST(st) : null;
        const etJ = et ? toJST(et) : null;
        rows.push({
          routeName: d.routeName || '',
          startTime: stJ ? `${pad(stJ.getUTCHours())}:${pad(stJ.getUTCMinutes())}` : '',
          endTime:   etJ ? `${pad(etJ.getUTCHours())}:${pad(etJ.getUTCMinutes())}` : ''
        });
      });
      rows.sort((a,b)=> (a.startTime||'') < (b.startTime||'') ? -1 : 1);
      if(rows.length===0){
        addTripRow({routeName:'', startTime:'', endTime:''});
      }else{
        rows.forEach(addTripRow);
      }
    };

    // 「運行を追加」ボタン（既存）
    document.getElementById('add-trip-button').onclick = ()=>{
      const row = { routeName:'', startTime:'', endTime:'' };
      const el = document.createElement('div');
      el.className = 'subgrid-row';
      el.style.display = 'grid';
      el.style.gridTemplateColumns = '1fr 1fr 1fr 1fr';
      el.style.gap = '8px';
      el.style.marginBottom = '8px';
      const f1 = document.createElement('input'); f1.type='text';  f1.value = row.routeName;
      const f2 = document.createElement('input'); f2.type='time';  f2.value = row.startTime;
      const f3 = document.createElement('input'); f3.type='time';  f3.value = row.endTime;
      const f4 = document.createElement('input'); f4.type='number'; f4.placeholder='人数';
      el.appendChild(f1); el.appendChild(f2); el.appendChild(f3); el.appendChild(f4);
      document.getElementById('trip-log-container').appendChild(el);
    };
  </script>
</body>
</html>
