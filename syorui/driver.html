<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ドライバー運行画面</title>

<!-- Bootstrap（バッジ用） -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { margin:0; background:#f8fafc; font-family:system-ui, -apple-system, "Noto Sans JP", sans-serif; }
  header { background:#0f172a; color:white; padding:10px; text-align:center; font-weight:bold; }
  main { padding:10px; display:grid; gap:12px; }
  .card { background:white; border-radius:14px; padding:12px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
  select, button, input[type="number"] {
    width:100%; padding:14px; font-size:18px; border-radius:12px; border:1px solid #ccc; box-sizing:border-box;
  }
  button.primary { background:#2563eb; color:white; border:none; }
  button.primary:disabled { background:#94a3b8; color:#e5e7eb; }
  button.danger  { background:#ef4444; color:white; border:none; }
  .hidden { display:none; }
  .stopDisplay { font-size:20px; text-align:center; font-weight:bold; margin:10px 0; }
  .navButtons { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .note { color:#64748b; font-size:12px; text-align:center; }

  /* アコーディオン */
  .accordion-header {
    width:100%;
    text-align:left;
    padding:12px 14px;
    border-radius:10px;
    border:1px solid #e5e7eb;
    background:#f1f5f9;
    font-size:16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    cursor:pointer;
  }
  .accordion-header span.label {
    font-weight:600;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .accordion-header span.icon { font-size:18px; }
  .accordion-body {
    margin-top:10px;
    border-top:1px solid #e5e7eb;
    padding-top:10px;
  }
  .precheck-row { margin-bottom:8px; font-size:14px; }
  .precheck-row label { display:block; margin-bottom:4px; }
  .precheck-row .radio-group {
    display:flex;
    gap:12px;
    font-size:14px;
  }
  .precheck-row .radio-group label {
    display:flex;
    align-items:center;
    gap:4px;
    margin:0;
  }
  .precheck-hint { font-size:12px; color:#64748b; margin-top:4px; }
</style>
</head>
<body>

<header>ドライバー運行システム</header>

<main>
  <!-- 運行前の -->
  <section id="setupSection" class="card">
    <h3>ルート選択</h3>
    <select id="routeSelect" disabled>
      <option>ルートを取得中...</option>
    </select>
    <button id="btnStart" class="primary" disabled>運行開始</button>
  </section>

  <!-- 運行中の -->
  <section id="driveSection" class="card hidden">
    <div class="stopDisplay">
      次の停留所：<span id="currentStop">-</span>
    </div>
    <div class="navButtons">
      <button id="btnPrevStop">前の停留所へ</button>
      <button id="btnNextStop">次の停留所へ</button>
    </div>
    <button id="btnStop" class="danger" style="margin-top:12px;">位置情報共有停止</button>
  </section>

  <!-- 地図だった場所 → アコーディオン式の運行前チェック -->
  <section id="mapSection" class="card">
    <button id="precheckToggle" class="accordion-header" type="button">
      <span class="label">
        運行前チェック
        <!-- 状態バッジ -->
        <span id="precheckStatus">
          <span class="badge text-bg-secondary" style="font-size:14px;">未入力</span>
        </span>
      </span>
      <span class="icon" id="precheckIcon">＋</span>
    </button>
    <div id="precheckBody" class="accordion-body hidden">
      <div class="precheck-row">
        <label for="alcoholInput">アルコール量 (mg/L)</label>
        <input type="number" id="alcoholInput" step="0.01" min="0" placeholder="例: 0.00" />
        <div class="precheck-hint">
          ※ 国の基準値 0.15mg/L 以下でないと運行開始できません。
        </div>
      </div>

      <div class="precheck-row">
        <label>車両清掃</label>
        <div class="radio-group">
          <label><input type="radio" name="clean" value="ok"> 清掃済み</label>
          <label><input type="radio" name="clean" value="ng"> 問題あり</label>
        </div>
      </div>

      <div class="precheck-row">
        <label>傷の有無</label>
        <div class="radio-group">
          <label><input type="radio" name="scratch" value="ok"> 新たな傷なし</label>
          <label><input type="radio" name="scratch" value="ng"> 気になる傷あり</label>
        </div>
      </div>

      <div class="precheck-row">
        <label>免許証</label>
        <div class="radio-group">
          <label><input type="radio" name="license" value="ok"> 所持確認済み</label>
          <label><input type="radio" name="license" value="ng"> 未確認／不所持</label>
        </div>
      </div>

      <div class="precheck-row">
        <label>服装</label>
        <div class="radio-group">
          <label><input type="radio" name="dress" value="ok"> 乱れなし</label>
          <label><input type="radio" name="dress" value="ng"> 乱れあり</label>
        </div>
      </div>

      <div class="precheck-row">
        <label>名札</label>
        <div class="radio-group">
          <label><input type="radio" name="nametag" value="ok"> 着用済み</label>
          <label><input type="radio" name="nametag" value="ng"> 未着用</label>
        </div>
      </div>

      <div class="precheck-row">
        <label>体調</label>
        <div class="radio-group">
          <label><input type="radio" name="condition" value="ok"> 良好</label>
          <label><input type="radio" name="condition" value="ng"> 不調</label>
        </div>
      </div>

      <div class="precheck-hint">
        ※ すべて「OK」かつアルコール量が 0.15mg/L 以下の状態で「運行前チェックを保存」すると、運行開始が可能になります。
      </div>

      <!-- 保存ボタン -->
      <button id="btnSavePrecheck" type="button" class="btn btn-sm btn-primary w-100 mt-2">
        運行前チェックを保存
      </button>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // --- Firebase設定 ---
  const firebaseConfig = {
    apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
    authDomain: "the-bus-94fe3.firebaseapp.com",
    projectId: "the-bus-94fe3",
    storageBucket: "the-bus-94fe3.firebasestorage.app",
    messagingSenderId: "782387450057",
    appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const routeSelect = document.getElementById("routeSelect");
  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const btnNextStop = document.getElementById("btnNextStop");
  const btnPrevStop = document.getElementById("btnPrevStop");
  const currentStopEl = document.getElementById("currentStop");

  const setupSection = document.getElementById("setupSection");
  const driveSection = document.getElementById("driveSection");
  const mapSection = document.getElementById("mapSection");

  // アコーディオン
  const precheckToggle = document.getElementById("precheckToggle");
  const precheckBody   = document.getElementById("precheckBody");
  const precheckIcon   = document.getElementById("precheckIcon");

  // 運行前チェック UI
  const alcoholInput   = document.getElementById("alcoholInput");
  const btnSavePrecheck = document.getElementById("btnSavePrecheck");
  const precheckStatus  = document.getElementById("precheckStatus");

  // --- 状態 ---
  let user = null;
  let myRoutes = [];
  let activeRoute = null;
  let currentStopIndex = 0;
  let watchId = null;
  let lastWriteAt = 0;
  const MIN_WRITE_INTERVAL_MS = 3500;

  let precheckInputsPass = false; // 入力として条件を満たしているか
  let precheckSavedPass  = false; // Firestore に保存済みかつ条件OKか（当日）
  let hasRoutes = false;          // ルートがあるか

  // アルコール基準値：0.15mg/L 以下ならOK
  const ALCOHOL_LIMIT = 0.15;

  const toDate = (v)=> v?.toDate ? v.toDate() : (v ? new Date(v) : null);
  const nowMs = ()=> Date.now();

  function jstTimestampId(date = new Date()) {
    const d = new Date(date.getTime() + 9*60*60*1000); // +9h
    const pad = n => String(n).padStart(2,'0');
    const yyyy = d.getUTCFullYear();
    const MM   = pad(d.getUTCMonth()+1);
    const dd   = pad(d.getUTCDate());
    const HH   = pad(d.getUTCHours());
    const mm   = pad(d.getUTCMinutes());
    const ss   = pad(d.getUTCSeconds());
    return `${yyyy}${MM}${dd}${HH}${mm}${ss}`;
  }

  function todayKey() {
    const n = new Date();
    const y = n.getFullYear();
    const m = String(n.getMonth()+1).padStart(2,"0");
    const d = String(n.getDate()).padStart(2,"0");
    return `${y}${m}${d}`;
  }

  // 運行開始ボタン有効/無効
  function updateStartButtonState() {
    // ルートあり + 当日の運行前チェックが「保存済みでOK」のときだけ開始できる
    btnStart.disabled = !(hasRoutes && precheckSavedPass);
  }

  // バッジ更新
  function setStatusBadge(type) {
    if (type === "none") {
      precheckStatus.innerHTML =
        `<span class="badge text-bg-secondary" style="font-size:14px;">未入力</span>`;
    } else if (type === "invalid") {
      precheckStatus.innerHTML =
        `<span class="badge text-bg-danger" style="font-size:14px;">✖ 未完了</span>`;
    } else if (type === "valid_unsaved") {
      precheckStatus.innerHTML =
        `<span class="badge text-bg-warning" style="font-size:14px;">△ 入力OK（未保存）</span>`;
    } else if (type === "saved_ok") {
      precheckStatus.innerHTML =
        `<span class="badge text-bg-success" style="font-size:14px;">✔ 保存済み</span>`;
    }
  }

  // ラジオボタンの値取得
  function getRadioVal(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : "";
  }

  // ラジオボタンがどちらか選ばれているか
  function radioFilled(name) {
    return !!document.querySelector(`input[name="${name}"]:checked`);
  }

  // アルコール入力されているか
  function alcInputTouched() {
    return alcoholInput.value !== "";
  }

  // 運行前チェックの入力評価（保存はしない）
  function evaluatePrecheck() {
    const alc = parseFloat(alcoholInput.value);
    const alcValid = !isNaN(alc) && alc >= 0 && alc <= ALCOHOL_LIMIT;

    const cleanVal     = getRadioVal("clean");
    const scratchVal   = getRadioVal("scratch");
    const licenseVal   = getRadioVal("license");
    const dressVal     = getRadioVal("dress");
    const nametagVal   = getRadioVal("nametag");
    const conditionVal = getRadioVal("condition");

    const allSelectOk =
      cleanVal     === "ok" &&
      scratchVal   === "ok" &&
      licenseVal   === "ok" &&
      dressVal     === "ok" &&
      nametagVal   === "ok" &&
      conditionVal === "ok";

    const allSelectFilled =
      radioFilled("clean") &&
      radioFilled("scratch") &&
      radioFilled("license") &&
      radioFilled("dress") &&
      radioFilled("nametag") &&
      radioFilled("condition");

    // 入力が変わったら「保存済みフラグ」は落とす
    precheckSavedPass = false;

    if (!alcInputTouched() && !allSelectFilled) {
      precheckInputsPass = false;
      setStatusBadge("none");
      updateStartButtonState();
      return;
    }

    if (!alcValid || !allSelectOk) {
      precheckInputsPass = false;
      setStatusBadge("invalid");
      updateStartButtonState();
      return;
    }

    // 入力条件はOK（ただしまだ未保存）
    precheckInputsPass = true;
    setStatusBadge("valid_unsaved");
    updateStartButtonState();
  }

  // 入力イベント（アルコール＋ラジオ全部）
  const radioNames = ["clean","scratch","license","dress","nametag","condition"];
  radioNames.forEach(name => {
    document.querySelectorAll(`input[name="${name}"]`).forEach(el => {
      el.addEventListener("change", evaluatePrecheck);
    });
  });
  alcoholInput.addEventListener("input", evaluatePrecheck);
  alcoholInput.addEventListener("change", evaluatePrecheck);

  // アコーディオン開閉
  precheckToggle.addEventListener("click", () => {
    const isHidden = precheckBody.classList.contains("hidden");
    if (isHidden) {
      precheckBody.classList.remove("hidden");
      precheckIcon.textContent = "－";
    } else {
      precheckBody.classList.add("hidden");
      precheckIcon.textContent = "＋";
    }
  });

  // 当日の運行前チェック（保存済み）の有無を確認
  async function loadTodayPrecheck() {
    if (!user) return;
    try {
      const logsCol = collection(db, "preChecks", user.uid, "logs");
      const q1 = query(
        logsCol,
        where("dateKey", "==", todayKey()),
        where("passed", "==", true)
      );
      const snap = await getDocs(q1);
      if (!snap.empty) {
        // 当日すでにOKなチェックがある → スキップ可能
        precheckSavedPass = true;
        setStatusBadge("saved_ok");
      } else {
        precheckSavedPass = false;
        setStatusBadge("none");
      }
    } catch (e) {
      console.error("loadTodayPrecheck error", e);
      precheckSavedPass = false;
      setStatusBadge("none");
    }
    updateStartButtonState();
  }

  // 運行前チェックを Firestore に保存（上書きしない：ログ追加）
  btnSavePrecheck.onclick = async () => {
    evaluatePrecheck(); // 最新の入力状態を反映

    if (!precheckInputsPass) {
      alert("運行前チェックの条件を満たしていません。各項目を確認してください。");
      return;
    }
    if (!user) {
      alert("ログイン待機中です。少し待ってから再度お試しください。");
      return;
    }

    try {
      const alc = parseFloat(alcoholInput.value);
      const docId = jstTimestampId(new Date()); // JSTタイムスタンプ → 上書きされない
      const ref = doc(db, "preChecks", user.uid, "logs", docId);

      await setDoc(ref, {
        uid: user.uid,
        dateKey: todayKey(),            // 日付キー（YYYYMMDD）→ 当日分の検索に使用
        checkedAt: serverTimestamp(),
        alcoholMgL: alc,
        cleaned:     getRadioVal("clean")     === "ok",
        scratchOk:   getRadioVal("scratch")   === "ok",
        licenseOk:   getRadioVal("license")   === "ok",
        dressOk:     getRadioVal("dress")     === "ok",
        nameTagOk:   getRadioVal("nametag")   === "ok",
        conditionOk: getRadioVal("condition") === "ok",
        passed:      true
      });

      precheckSavedPass = true;
      setStatusBadge("saved_ok");
      updateStartButtonState();
      alert("運行前チェックを保存しました。運行開始が可能です。");
    } catch (e) {
      console.error("preChecks 保存エラー", e);
      alert("運行前チェックの保存に失敗しました。通信状態を確認してください。");
    }
  };

  // --- 匿名ログイン ---
  onAuthStateChanged(auth, async (u)=>{
    if(!u){
      await signInAnonymously(auth);
    }else{
      user = u;
      await loadRoutes();
      await loadTodayPrecheck();
    }
  });

  async function loadRoutes(){
    const q1 = query(collection(db,"routes"), where("uid","==", user.uid));
    const snap = await getDocs(q1);
    myRoutes = [];
    snap.forEach(docSnap => myRoutes.push({ id:docSnap.id, ...docSnap.data() }));

    myRoutes.sort((a,b)=>{
      const as = toDate(a.serviceDate) ?? new Date(0);
      const bs = toDate(b.serviceDate) ?? new Date(0);
      if (as - bs !== 0) return as - bs;
      const at = toDate(a.startTime) ?? new Date(0);
      const bt = toDate(b.startTime) ?? new Date(0);
      return at - bt;
    });

    refreshRouteSelect();
  }

  function refreshRouteSelect(){
    routeSelect.innerHTML = "";
    if(myRoutes.length===0){
      routeSelect.innerHTML = "<option>該当ルートなし</option>";
      routeSelect.disabled = true;
      hasRoutes = false;
      updateStartButtonState();
      return;
    }
    myRoutes.forEach(r=>{
      const opt=document.createElement("option");
      const sd = toDate(r.serviceDate);
      const st = toDate(r.startTime);
      opt.value=r.id;
      opt.textContent=`${r.routeName||"(無名)"} ／ ${sd?sd.toLocaleDateString('ja-JP'):''} ${st?st.toLocaleTimeString('ja-JP',{hour12:false}):''}`;
      routeSelect.appendChild(opt);
    });
    routeSelect.disabled=false;

    if (routeSelect.value) {
      activeRoute = myRoutes.find(r=>r.id===routeSelect.value) || null;
    }
    hasRoutes = true;
    updateStartButtonState();
  }

  routeSelect.addEventListener("change",()=>{
    const id = routeSelect.value;
    activeRoute = myRoutes.find(r=>r.id===id)||null;
  });

  function computeDelayMinutes(){
    if(!activeRoute?.stops || activeRoute.stops.length===0) return 0;
    const s = activeRoute.stops[currentStopIndex];
    if(!s?.eta) return 0;
    const eta = toDate(s.eta);
    if(!eta) return 0;
    const diffMin = Math.round((nowMs() - eta.getTime())/60000);
    return Math.max(0, diffMin);
  }

  function getNextStopInfo(){
    if(!activeRoute?.stops) return null;
    const i = Math.min(currentStopIndex+1, activeRoute.stops.length-1);
    const s = activeRoute.stops[i];
    if(!s) return null;
    return { name: s.name || null, eta: toDate(s.eta) || null };
  }

  async function writeLiveAndHistory(coords){
    if(!user || !activeRoute) return;
    const { latitude:lat, longitude:lng, accuracy, speed, heading } = coords;
    const currentStopName = activeRoute.stops?.[currentStopIndex]?.name || null;
    const delayMinutes = computeDelayMinutes();
    const next = getNextStopInfo();

    await setDoc(doc(db, "livePositions", user.uid), {
      uid: user.uid,
      email: user.email || null,
      lat, lng, accuracy: accuracy ?? null, speed: speed ?? null, heading: heading ?? null,
      updatedAt: serverTimestamp(),
      routeId: activeRoute.routeId || activeRoute.id || null,
      routeName: activeRoute.routeName || null,
      currentStopName,
      nextStop: next ? { name: next.name, eta: next.eta } : null,
      delayMinutes
    }, { merge: true });

    const t = nowMs();
    if (t - lastWriteAt >= MIN_WRITE_INTERVAL_MS) {
      lastWriteAt = t;

      const baseId = jstTimestampId(new Date());
      let docId = baseId;
      let ref   = doc(db, "drivers", user.uid, "positions", docId);

      const snap = await getDoc(ref);
      if (snap.exists()) {
        const ms = String(new Date().getMilliseconds()).padStart(3,'0');
        docId = `${baseId}${ms}`;
        ref = doc(db, "drivers", user.uid, "positions", docId);
      }

      await setDoc(ref, {
        uid: user.uid,
        email: user.email || null,
        lat, lng, accuracy: accuracy ?? null, speed: speed ?? null, heading: heading ?? null,
        clientAt: new Date(),          // 端末時刻
        serverAt: serverTimestamp(),   // サーバ時刻
        routeId: activeRoute.routeId || activeRoute.id || null,
        routeName: activeRoute.routeName || null,
        currentStopName,
        nextStopName: next?.name || null,
        delayMinutes
      });
    }
  }

  btnStart.onclick=()=>{
    if (!precheckSavedPass) {
      alert("当日の運行前チェックが保存されていません。「運行前チェックを保存」を実行してください。");
      return;
    }

    const selectedId = routeSelect.value;
    activeRoute = myRoutes.find(r=>r.id===selectedId)||null;
    if(!activeRoute){ alert("ルートを選択してください"); return; }

    setupSection.classList.add("hidden");
    driveSection.classList.remove("hidden");
    mapSection.classList.add("hidden");   // 運行中はチェックパネルを隠す

    currentStopIndex = 0;
    currentStopEl.textContent = activeRoute.stops?.[0]?.name || "-";
    lastWriteAt = 0;

    watchId = navigator.geolocation.watchPosition(async pos=>{
      try { await writeLiveAndHistory(pos.coords); }
      catch(e){ console.error("write error", e); }
    }, err => alert("位置取得失敗: " + err.message),
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 });
  };

  async function syncLiveOnly(){
    if(!user || !activeRoute) return;
    const currentStopName = activeRoute.stops?.[currentStopIndex]?.name || null;
    const delayMinutes = computeDelayMinutes();
    const next = getNextStopInfo();
    await setDoc(doc(db, "livePositions", user.uid), {
      uid: user.uid,
      routeId: activeRoute.routeId || activeRoute.id || null,
      routeName: activeRoute.routeName || null,
      currentStopName,
      nextStop: next ? { name: next.name, eta: next.eta } : null,
      delayMinutes,
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  btnNextStop.onclick=async()=>{
    if(!activeRoute?.stops) return;
    if(currentStopIndex < activeRoute.stops.length-1){
      currentStopIndex++;
      currentStopEl.textContent = activeRoute.stops[currentStopIndex].name;
      try { await syncLiveOnly(); } catch(e){ console.error(e); }
    }
  };
  btnPrevStop.onclick=async()=>{
    if(currentStopIndex>0){
      currentStopIndex--;
      currentStopEl.textContent = activeRoute.stops[currentStopIndex].name;
      try { await syncLiveOnly(); } catch(e){ console.error(e); }
    }
  };

  btnStop.onclick=()=>{
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
    setupSection.classList.remove("hidden");
    driveSection.classList.add("hidden");
    mapSection.classList.remove("hidden");  // 停止後に再びチェックパネルを表示
  };
</script>
</body>
</html>
