<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ドライバー運行画面</title>

<style>
  body { margin:0; background:#f8fafc; font-family:system-ui, -apple-system, "Noto Sans JP", sans-serif; }
  header { background:#0f172a; color:white; padding:10px; text-align:center; font-weight:bold; }
  main { padding:10px; display:grid; gap:12px; }
  .card { background:white; border-radius:14px; padding:12px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }

  select, button, input, textarea {
    width:100%;
    padding:10px;
    font-size:16px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    box-sizing:border-box;
  }
  button.primary { background:#2563eb; color:white; border:none; }
  button.danger  { background:#ef4444; color:white; border:none; }
  button:disabled{ background:#cbd5e1 !important; color:#6b7280; }

  .hidden { display:none; }
  .stopDisplay { font-size:20px; text-align:center; font-weight:bold; margin:10px 0; }
  .navButtons { display:grid; grid-template-columns:1fr 1fr; gap:8px; }

  /* 運行前チェック */
  .accordion-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    cursor:pointer;
    padding:6px 0;
  }
  .accordion-title{
    font-weight:bold;
  }
  .accordion-toggle{
    font-size:20px;
    line-height:1;
    padding:0 4px;
  }
  .badge{
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    margin-left:6px;
  }
  .badge-ok{
    background:#dcfce7;
    color:#166534;
  }
  .badge-ng{
    background:#fee2e2;
    color:#b91c1c;
  }
  .pre-row{
    margin-bottom:10px;
    font-size:14px;
  }
  .pre-label{
    font-weight:bold;
    margin-bottom:4px;
  }
  .pre-inline{
    display:flex;
    align-items:center;
    flex-wrap:wrap;
    gap:10px;
    margin-top:4px;
  }
  .pre-inline span.head{
    min-width:80px;
  }
  .pre-inline label{
    display:flex;
    align-items:center;
    gap:4px;
  }
  .pre-inline input[type="radio"]{
    width:auto;
  }
  .small-note{
    font-size:12px;
    color:#6b7280;
    margin-top:2px;
  }
</style>
</head>
<body>

<header>ドライバー運行システム</header>

<main>
  <!-- 運行前 -->
  <section id="setupSection" class="card">
    <h3>ルート選択</h3>
    <select id="routeSelect" disabled>
      <option>ルートを取得中...</option>
    </select>
    <button id="btnStart" class="primary" disabled style="margin-top:10px;">運行開始</button>

    <!-- 運行前チェック（アコーディオン） -->
    <div style="margin-top:14px;">
      <div class="accordion-header" id="preCheckHeader">
        <div class="accordion-title">
          運行前チェック
          <span id="preCheckBadge" class="badge badge-ng">未完了</span>
        </div>
        <div class="accordion-toggle">－</div>
      </div>
      <div id="preCheckBody">
        <!-- ★ ここから新しい項目を含む運行前チェック本体 ★ -->

        <div class="pre-row">
          <div class="pre-label">確認者名（安全運転管理者 等）</div>
          <input type="text" id="preConfirmer" placeholder="例：山田 安全管理者">
        </div>

        <div class="pre-row">
          <div class="pre-label">車両ナンバー</div>
          <input type="text" id="preVehicleNumber" placeholder="例：品川300 あ 12-34">
        </div>

        <div class="pre-row">
          <div class="pre-label">確認方法</div>
          <select id="preConfirmMethod">
            <option value="">選択してください</option>
            <option value="device_face">アルコール検知器（対面）</option>
            <option value="device_remote">アルコール検知器（遠隔）</option>
            <option value="face_only">対面（目視のみ）</option>
            <option value="other">その他</option>
          </select>
          <div class="small-note">※ アルコール検知器の使用有無を含めて選択してください。</div>
        </div>

        <div class="pre-row" id="preRemoteDetailRow" style="display:none;">
          <div class="pre-label">対面でない場合の具体的な方法</div>
          <input type="text" id="preRemoteDetail" placeholder="例：Web会議で検知器の数値と顔色を確認">
        </div>

        <div class="pre-row">
          <div class="pre-label">アルコール量 (mg/L)</div>
          <input type="number" id="preAlcohol" step="0.01" min="0" placeholder="0.00">
        </div>

        <div class="pre-row">
          <div class="pre-label">アルコール検知器の表示写真</div>
          <input type="file" id="prePhoto" accept="image/*">
          <div class="small-note">※ 検知器の表示が分かるように撮影してください。</div>
        </div>

        <!-- 以下、元々あったラジオボタン群（デザインそのまま） -->
        <div class="pre-row">
          <div class="pre-label">車両清掃</div>
          <div class="pre-inline">
            <label><input type="radio" name="cleaned" value="yes"> 清掃済み</label>
            <label><input type="radio" name="cleaned" value="no"> 問題あり</label>
          </div>
        </div>

        <div class="pre-row">
          <div class="pre-label">傷の有無</div>
          <div class="pre-inline">
            <label><input type="radio" name="scratchOk" value="yes"> 新たな傷なし</label>
            <label><input type="radio" name="scratchOk" value="no"> 気になる傷あり</label>
          </div>
        </div>

        <div class="pre-row">
          <div class="pre-label">免許証</div>
          <div class="pre-inline">
            <label><input type="radio" name="licenseOk" value="yes"> 所持確認済み</label>
            <label><input type="radio" name="licenseOk" value="no"> 未確認 / 不持</label>
          </div>
        </div>

        <div class="pre-row">
          <div class="pre-label">服装</div>
          <div class="pre-inline">
            <label><input type="radio" name="dressOk" value="yes"> 乱れなし</label>
            <label><input type="radio" name="dressOk" value="no"> 乱れあり</label>
          </div>
        </div>

        <div class="pre-row">
          <div class="pre-label">名札</div>
          <div class="pre-inline">
            <label><input type="radio" name="nameTagOk" value="yes"> 着用済み</label>
            <label><input type="radio" name="nameTagOk" value="no"> 未着用</label>
          </div>
        </div>

        <div class="pre-row">
          <div class="pre-label">体調</div>
          <div class="pre-inline">
            <label><input type="radio" name="conditionOk" value="yes"> 良好</label>
            <label><input type="radio" name="conditionOk" value="no"> 不調</label>
          </div>
        </div>

        <div class="pre-row">
          <button id="btnSavePreCheck" type="button" class="primary">運行前チェックを保存</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 運行中 -->
  <section id="driveSection" class="card hidden">
    <div class="stopDisplay">
      次の停留所：<span id="currentStop">-</span>
    </div>
    <div class="navButtons">
      <button id="btnPrevStop">前の停留所へ</button>
      <button id="btnNextStop">次の停留所へ</button>
    </div>
    <button id="btnStop" class="danger" style="margin-top:12px;">位置情報共有停止</button>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    doc,
    setDoc,
    getDoc,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // --- Firebase設定 ---
  const firebaseConfig = {
    apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
    authDomain: "the-bus-94fe3.firebaseapp.com",
    projectId: "the-bus-94fe3",
    storageBucket: "the-bus-94fe3.firebasestorage.app",
    messagingSenderId: "782387450057",
    appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const storage = getStorage(app);

  // --- UI参照 ---
  const routeSelect   = document.getElementById("routeSelect");
  const btnStart      = document.getElementById("btnStart");
  const btnStop       = document.getElementById("btnStop");
  const btnNextStop   = document.getElementById("btnNextStop");
  const btnPrevStop   = document.getElementById("btnPrevStop");
  const currentStopEl = document.getElementById("currentStop");

  const setupSection  = document.getElementById("setupSection");
  const driveSection  = document.getElementById("driveSection");

  const preCheckHeader    = document.getElementById("preCheckHeader");
  const preCheckBody      = document.getElementById("preCheckBody");
  const preCheckBadge     = document.getElementById("preCheckBadge");
  const btnSavePreCheck   = document.getElementById("btnSavePreCheck");
  const preCheckTsLabel   = document.getElementById("preCheckTimestamp");
  const preRemoteDetailRow= document.getElementById("preRemoteDetailRow");

  const inputConfirmer    = document.getElementById("preConfirmer");
  const inputVehicleNo    = document.getElementById("preVehicleNumber");
  const selectMethod      = document.getElementById("preConfirmMethod");
  const inputRemoteDetail = document.getElementById("preRemoteDetail");
  const inputAlcohol      = document.getElementById("preAlcohol");
  const inputPhoto        = document.getElementById("prePhoto");

  // --- 状態 ---
  let user = null;
  let myRoutes = [];
  let activeRoute = null;
  let currentStopIndex = 0;
  let watchId = null;
  let lastWriteAt = 0;
  const MIN_WRITE_INTERVAL_MS = 3500;
  let preCheckDoneToday = false;

  // util
  const toDate = (v)=> v?.toDate ? v.toDate() : (v ? new Date(v) : null);
  const nowMs = ()=> Date.now();

  function jstTimestampId(date = new Date()) {
    const d = new Date(date.getTime() + 9*60*60*1000); // +9h
    const pad = n => String(n).padStart(2,'0');
    const yyyy = d.getUTCFullYear();
    const MM   = pad(d.getUTCMonth()+1);
    const dd   = pad(d.getUTCDate());
    const HH   = pad(d.getUTCHours());
    const mm   = pad(d.getUTCHours()); // （※使わないが残してもOK）
    const ss   = pad(d.getUTCSeconds());
    return `${yyyy}${MM}${dd}${HH}${mm}${ss}`;
  }
  function todayKeyJst(){
    const d = new Date(Date.now() + 9*60*60*1000);
    const pad = n => String(n).padStart(2,"0");
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}`;
  }

  function updateStartButton(){
    const routeOk = !!activeRoute;
    const preOk   = preCheckDoneToday;
    btnStart.disabled = !(routeOk && preOk);
  }

  // 匿名ログイン
  onAuthStateChanged(auth, async (u)=>{
    if(!u){
      await signInAnonymously(auth);
    }else{
      user = u;
      await Promise.all([loadRoutes(), loadTodayPreCheckStatus()]);
    }
  });

  // ルート読み込み
  async function loadRoutes(){
    if (!user) return;
    const q1 = query(collection(db,"routes"), where("uid","==", user.uid));
    const snap = await getDocs(q1);
    myRoutes = [];
    snap.forEach(docSnap => myRoutes.push({ id:docSnap.id, ...docSnap.data() }));

    myRoutes.sort((a,b)=>{
      const as = toDate(a.serviceDate) ?? new Date(0);
      const bs = toDate(b.serviceDate) ?? new Date(0);
      if (as - bs !== 0) return as - bs;
      const at = toDate(a.startTime) ?? new Date(0);
      const bt = toDate(b.startTime) ?? new Date(0);
      return at - bt;
    });

    routeSelect.innerHTML = "";
    if(myRoutes.length===0){
      routeSelect.innerHTML = "<option>該当ルートなし</option>";
      routeSelect.disabled = true;
      updateStartButton();
      return;
    }
    myRoutes.forEach(r=>{
      const opt=document.createElement("option");
      const sd = toDate(r.serviceDate);
      const st = toDate(r.startTime);
      opt.value=r.id;
      opt.textContent=`${r.routeName||"(無名)"} ／ ${sd?sd.toLocaleDateString('ja-JP'):''} ${st?st.toLocaleTimeString('ja-JP',{hour12:false}):''}`;
      routeSelect.appendChild(opt);
    });
    routeSelect.disabled=false;

    if (routeSelect.value) {
      activeRoute = myRoutes.find(r=>r.id===routeSelect.value) || null;
    }
    updateStartButton();
  }

  routeSelect.addEventListener("change",()=>{
    const id = routeSelect.value;
    activeRoute = myRoutes.find(r=>r.id===id)||null;
    updateStartButton();
  });

  // 今日の運行前チェック状況
  async function loadTodayPreCheckStatus(){
    if (!user) return;
    try{
      const logsSnap = await getDocs(collection(db,"preChecks", user.uid, "logs"));
      const key = todayKeyJst();
      let latest = null;
      logsSnap.forEach(docSnap=>{
        const d = docSnap.data();
        if (d.dateKey === key && d.passed) {
          if (!latest) latest = d;
          else if (d.checkedAt && latest.checkedAt && d.checkedAt.toDate && latest.checkedAt.toDate) {
            if (d.checkedAt.toDate() > latest.checkedAt.toDate()) latest = d;
          }
        }
      });
      if (latest) {
        preCheckDoneToday = true;
        preCheckBadge.textContent = "本日チェック済";
        preCheckBadge.classList.remove("badge-ng");
        preCheckBadge.classList.add("badge-ok");
        if (latest.checkedAt && latest.checkedAt.toDate) {
          const t = latest.checkedAt.toDate();
          preCheckTsLabel.textContent = `最終確認：${t.toLocaleString("ja-JP")}`;
        }
      } else {
        preCheckDoneToday = false;
        preCheckBadge.textContent = "未完了";
        preCheckBadge.classList.remove("badge-ok");
        preCheckBadge.classList.add("badge-ng");
        preCheckTsLabel.textContent = "※ すべてOKのときのみ運行開始できます。";
      }
      updateStartButton();
    }catch(e){
      console.error("preChecks load error", e);
    }
  }

  // アコーディオン開閉
  preCheckHeader.addEventListener("click",()=>{
    preCheckBody.classList.toggle("hidden");
  });

  // 確認方法 → 遠隔などの場合の詳細欄
  selectMethod.addEventListener("change",()=>{
    const v = selectMethod.value;
    if (v === "device_remote" || v === "other") {
      preRemoteDetailRow.style.display = "";
    } else {
      preRemoteDetailRow.style.display = "none";
      inputRemoteDetail.value = "";
    }
  });

  // 遅延計算
  function computeDelayMinutes(){
    if(!activeRoute?.stops || activeRoute.stops.length===0) return 0;
    const s = activeRoute.stops[currentStopIndex];
    if(!s?.eta) return 0;
    const eta = toDate(s.eta);
    if(!eta) return 0;
    const diffMin = Math.round((nowMs() - eta.getTime())/60000);
    return Math.max(0, diffMin);
  }

  function getNextStopInfo(){
    if(!activeRoute?.stops) return null;
    const i = Math.min(currentStopIndex+1, activeRoute.stops.length-1);
    const s = activeRoute.stops[i];
    if(!s) return null;
    return { name: s.name || null, eta: toDate(s.eta) || null };
  }

  // livePositions & 履歴
  async function writeLiveAndHistory(coords){
    if(!user || !activeRoute) return;
    const { latitude:lat, longitude:lng, accuracy, speed, heading } = coords;
    const currentStopName = activeRoute.stops?.[currentStopIndex]?.name || null;
    const delayMinutes = computeDelayMinutes();
    const next = getNextStopInfo();

    await setDoc(doc(db, "livePositions", user.uid), {
      uid: user.uid,
      email: user.email || null,
      lat, lng, accuracy: accuracy ?? null, speed: speed ?? null, heading: heading ?? null,
      updatedAt: serverTimestamp(),
      routeId: activeRoute.routeId || activeRoute.id || null,
      routeName: activeRoute.routeName || null,
      currentStopName,
      nextStop: next ? { name: next.name, eta: next.eta } : null,
      delayMinutes
    }, { merge: true });

    const t = nowMs();
    if (t - lastWriteAt >= MIN_WRITE_INTERVAL_MS) {
      lastWriteAt = t;

      const baseId = jstTimestampId(new Date());
      let docId = baseId;
      let ref   = doc(db, "drivers", user.uid, "positions", docId);

      const snap = await getDoc(ref);
      if (snap.exists()) {
        const ms = String(new Date().getMilliseconds()).padStart(3,'0');
        docId = `${baseId}${ms}`;
        ref = doc(db, "drivers", user.uid, "positions", docId);
      }

      await setDoc(ref, {
        uid: user.uid,
        email: user.email || null,
        lat, lng, accuracy: accuracy ?? null, speed: speed ?? null, heading: heading ?? null,
        clientAt: new Date(),
        serverAt: serverTimestamp(),
        routeId: activeRoute.routeId || activeRoute.id || null,
        routeName: activeRoute.routeName || null,
        currentStopName,
        nextStopName: next?.name || null,
        delayMinutes
      });
    }
  }

  // 運行前チェック保存
  btnSavePreCheck.addEventListener("click", async ()=>{
    if (!user) {
      alert("ログイン情報がありません。");
      return;
    }

    const confirmerName = inputConfirmer.value.trim();
    const vehicleNumber = inputVehicleNo.value.trim();
    const method        = selectMethod.value;
    const alcoholStr    = inputAlcohol.value.trim();
    const alcoholMgL    = alcoholStr ? Number(alcoholStr) : NaN;

    const cleaned    = document.querySelector('input[name="cleaned"]:checked')?.value === "yes";
    const scratchOk  = document.querySelector('input[name="scratchOk"]:checked')?.value === "yes";
    const licenseOk  = document.querySelector('input[name="licenseOk"]:checked')?.value === "yes";
    const dressOk    = document.querySelector('input[name="dressOk"]:checked')?.value === "yes";
    const nameTagOk  = document.querySelector('input[name="nameTagOk"]:checked')?.value === "yes";
    const conditionOk= document.querySelector('input[name="conditionOk"]:checked')?.value === "yes";

    if (!confirmerName) { alert("確認者名を入力してください。"); return; }
    if (!vehicleNumber) { alert("車両ナンバーを入力してください。"); return; }
    if (!method)        { alert("確認方法を選択してください。"); return; }
    if (Number.isNaN(alcoholMgL)) {
      alert("アルコール量を入力してください。");
      return;
    }
    if (method === "device_remote" || method === "other") {
      if (!inputRemoteDetail.value.trim()) {
        alert("対面でない場合の具体的な方法を入力してください。");
        return;
      }
    }

    const deviceUsed   = method === "device_face" || method === "device_remote";
    const remoteDetail = inputRemoteDetail.value.trim() || null;

    // 0.15mg/l 以下でないとNG
    const alcoholOk =
      typeof alcoholMgL === "number" && !Number.isNaN(alcoholMgL) && alcoholMgL <= 0.15;

    const allChecksOk =
      alcoholOk &&
      cleaned && scratchOk && licenseOk &&
      dressOk && nameTagOk && conditionOk;

    const passed = allChecksOk;

    if (!passed) {
      if (!confirm("基準を満たしていない項目があります。この内容で保存しますか？")) {
        return;
      }
    }

    // 写真アップロード（任意）
    let photoUrl = null;
    const file = inputPhoto.files[0];
    const dateKey = todayKeyJst();

    try{
      if (file) {
        const path = `precheckPhotos/${user.uid}/${dateKey}_${file.name}`;
        const refSt = storageRef(storage, path);
        await uploadBytes(refSt, file);
        photoUrl = await getDownloadURL(refSt);
      }

      await addDoc(collection(db,"preChecks", user.uid, "logs"), {
        uid: user.uid,
        dateKey,
        checkedAt: serverTimestamp(),
        alcoholMgL,
        cleaned,
        scratchOk,
        licenseOk,
        dressOk,
        nameTagOk,
        conditionOk,
        passed,
        confirmerName,
        vehicleNumber,
        confirmMethod: method,
        deviceUsed,
        remoteDetail,
        photoUrl
      });

      alert("運行前チェックを保存しました。");
      await loadTodayPreCheckStatus();
    } catch(e){
      console.error(e);
      alert("運行前チェックの保存に失敗しました。");
    }
  });

  // 運行開始
  btnStart.onclick=()=>{
    const selectedId = routeSelect.value;
    activeRoute = myRoutes.find(r=>r.id===selectedId)||null;
    if(!activeRoute){ alert("ルートを選択してください"); return; }
    if(!preCheckDoneToday){
      alert("本日の運行前チェックが完了していません。");
      return;
    }

    setupSection.classList.add("hidden");
    driveSection.classList.remove("hidden");

    currentStopIndex = 0;
    currentStopEl.textContent = activeRoute.stops?.[0]?.name || "-";
    lastWriteAt = 0;

    watchId = navigator.geolocation.watchPosition(async pos=>{
      try { await writeLiveAndHistory(pos.coords); }
      catch(e){ console.error("write error", e); }
    }, err => alert("位置取得失敗: " + err.message),
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 });
  };

  // 停留所ボタン
  async function syncLiveOnly(){
    if(!user || !activeRoute) return;
    const currentStopName = activeRoute.stops?.[currentStopIndex]?.name || null;
    const delayMinutes = computeDelayMinutes();
    const next = getNextStopInfo();
    await setDoc(doc(db, "livePositions", user.uid), {
      uid: user.uid,
      routeId: activeRoute.routeId || activeRoute.id || null,
      routeName: activeRoute.routeName || null,
      currentStopName,
      nextStop: next ? { name: next.name, eta: next.eta } : null,
      delayMinutes,
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  btnNextStop.onclick=async()=>{
    if(!activeRoute?.stops) return;
    if(currentStopIndex < activeRoute.stops.length-1){
      currentStopIndex++;
      currentStopEl.textContent = activeRoute.stops[currentStopIndex].name;
      try { await syncLiveOnly(); } catch(e){ console.error(e); }
    }
  };
  btnPrevStop.onclick=async()=>{
    if(currentStopIndex>0){
      currentStopIndex--;
      currentStopEl.textContent = activeRoute.stops[currentStopIndex].name;
      try { await syncLiveOnly(); } catch(e){ console.error(e); }
    }
  };

  // 停止
  btnStop.onclick=()=>{
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
    setupSection.classList.remove("hidden");
    driveSection.classList.add("hidden");
  };
</script>
</body>
</html>



