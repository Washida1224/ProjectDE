<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ドライバー情報一覧</title>

  <link rel="stylesheet" href="../../CSS/layout-staff.css">
  <link rel="stylesheet" href="../../CSS/driver-list.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<style>
  .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #userEmail {
    font-size: 0.9rem;
  }

  .logout-btn {
    background-color: #39bdec;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.3s;
  }

  .logout-btn:hover {
    background-color: #0a6c7c;
  }
</style>
<body>
  <header>
        <div class="navbar">
            <div class="logo" >運行管理システム:ドライバーメニュー</div>
            <div class="user-info">
              <span id="userEmail">ログイン中: 読み込み中...</span>
              <button id="logoutBtn" class="logout-btn">ログアウト</button>
            </div>            
        </div>
    </header>

  <div class="toolbar">
    <div class="toolbar-left">
      <input type="text" id="searchBox" placeholder="名前で検索">
      <select id="sortBox">
        <option value="name">名前順</option>
        <option value="age">年齢順</option>
      </select>
    </div>
    <div class="toolbar-right">
      <button id="addDriverBtn"><i class="fas fa-plus"></i> 新規ドライバー追加</button>
    </div>
  </div>

  <main class="driver-layout">
    <div class="table-container">
      <table id="driverTable">
        <thead>
          <tr>
            <th>写真</th>
            <th>ID</th>
            <th>名前</th>
            <th>年齢</th>
            <th>免許種類</th>
            <th>健康状態</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

    <aside class="driver-detail" id="driverDetail">
      <p>左の一覧からドライバーを選択してください。</p>
    </aside>
  </main>

  <div class="back-btn">
    <button onclick="location.href='../../index-staff.html'">
      <i class="fas fa-arrow-left"></i> 戻る
    </button>
  </div>

  <footer>
    <p>© 2025 プロジェクト演習D,E：A08 | All Rights Reserved</p>
  </footer>

  
</body>

<script type="module"> 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        getDocs, 
        query, 
        orderBy, 
        FieldPath, 
        Timestamp,
        limit 
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
      authDomain: "the-bus-94fe3.firebaseapp.com",
      projectId: "the-bus-94fe3",
      storageBucket: "the-bus-94fe3.appspot.com",
      messagingSenderId: "782387450057",
      appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db  = getFirestore(app);

    const tbody       = document.querySelector("#driverTable tbody");
    const detailBox   = document.getElementById("driverDetail");
    const searchBox   = document.getElementById("searchBox");
    const sortBox     = document.getElementById("sortBox");
    const addDriverBtn= document.getElementById("addDriverBtn");
    const userEmailElement = document.getElementById("userEmail");

    const PLACEHOLDER_IMG = "https://via.placeholder.com/60?text=%20";

    let rowsCache = []; // {id, uid, name, age, licenseText, health, photo}

    onAuthStateChanged(auth, (user) => {
        if (user) {
            userEmailElement.textContent = `${user.email}`;
            loadDrivers();
        } else {
            window.location.href = "../syorui/login.html";
        }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
        try {
            await signOut(auth);
            window.location.href = "../../../syorui/login.html";
        } catch (error) {
            console.error("ログアウト失敗:", error);
            alert("ログアウトに失敗しました。");
        }
    });


    function calcAgeFromBirth(birth) {
      let d;
      if (!birth) return null;
      
      if (typeof birth.toDate === "function" || (birth && typeof birth === "object" && 'seconds' in birth)) {
        d = birth.toDate();
      } else if (birth instanceof Date) {
        d = birth;
      } else if (typeof birth === "string") {
        const t = Date.parse(birth);
        if (Number.isNaN(t)) return null;
        d = new Date(t);
      } else {
        return null;
      }
      
      const today = new Date();
      let age = today.getFullYear() - d.getFullYear();
      const m = today.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
      return age >= 0 && age < 130 ? age : null;
    }

    async function loadDrivers() {
      const driversRef = collection(db, "drivers");
      const qRef = query(driversRef, orderBy("name"));

      try {
        const snap = await getDocs(qRef);
        rowsCache = [];

        if (snap.empty) {
            tbody.innerHTML = '<tr><td colspan="6">該当するドライバー情報はありません。</td></tr>';
            return;
        }

        snap.forEach(doc => {
          const d = doc.data() || {};

          const id       = d.driverId || doc.id || "";
          const uid      = d.uid || "";        
          const name     = d.name || "不明";
          const age      = calcAgeFromBirth(d.birthDate);
          const licenses = Array.isArray(d.licenseTypes) ? d.licenseTypes : (d.licenseTypes ? [String(d.licenseTypes)] : []);
          const licenseText = licenses.length ? licenses.join("、") : "不明";
          const health   = d.healthSummary || "不明";
          const photo    = d.photoUrl || PLACEHOLDER_IMG;

          rowsCache.push({
            id, uid,
            name,
            age: (typeof age === "number" ? age : "N/A"),
            licenseText, health, photo
          });
        });

        renderTable(rowsCache);
        bindRowClicks();
      } catch (e) {
        console.error("ドライバーデータの読み込みに失敗しました:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="color:red;">データの読み込み中にエラーが発生しました。ログを確認してください。（${e.message || e.name}）</td></tr>`;
      }
    }

    function renderTable(list) {
      tbody.innerHTML = "";
      list.forEach(item => {
        const tr = document.createElement("tr");
        tr.setAttribute("data-detail", JSON.stringify({
          id: item.id,
          uid: item.uid,
          name: item.name,
          age: String(item.age),
          licenseText: item.licenseText,
          health: item.health,
          photo: item.photo
        }));
        tr.innerHTML = `
          <td><img src="${item.photo || PLACEHOLDER_IMG}" alt="${item.name}" width="60" height="60" style="object-fit:cover;border-radius:6px;"></td>
          <td>${item.id}</td>
          <td>${item.name}</td>
          <td>${item.age}</td>
          <td>${item.licenseText}</td>
          <td>${item.health}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function bindRowClicks() {
      document.querySelectorAll("#driverTable tbody tr").forEach(row => {
        row.addEventListener("click", () => {
          document.querySelectorAll("#driverTable tbody tr").forEach(r => r.classList.remove('selected-row'));
          row.classList.add('selected-row');

          const d = JSON.parse(row.getAttribute("data-detail"));
          const uidParam  = encodeURIComponent(d.uid || "");
          const nameParam = encodeURIComponent(d.name || "");
          detailBox.innerHTML = `
            <img src="${d.photo || PLACEHOLDER_IMG}" alt="${d.name}" style="width:100px; height:100px; object-fit:cover; border-radius:50%; margin-bottom:10px;">
            <h3>${d.name}（ID: ${d.id || "N/A"}）</h3>
            <p>年齢: ${d.age || "N/A"}</p>
            <p>免許種類: ${d.licenseText || "不明"}</p>
            <p>健康状態: ${d.health || "不明"}</p>
            <button onclick="location.href='https://washida1224.github.io/ProjectDE/syorui/driver_worktime.html?uid=${uidParam}&name=${nameParam}'" style="margin-top:15px; padding:10px 15px; background:#39bdec; color:white; border:none; border-radius:5px; cursor:pointer;">
              <i class="fas fa-calendar-alt"></i> 詳細ページへ
            </button>
          `;
        });
      });
      const firstRow = document.querySelector("#driverTable tbody tr");
      if(firstRow) {
        firstRow.click();
      }
    }
    
    const applyFilterAndSort = () => {
        const kw = searchBox.value.toLowerCase();
        const v = sortBox.value;
        
        let filtered = rowsCache.filter(r => (r.name || "").toLowerCase().includes(kw));
        
        const sorted = [...filtered].sort((a, b) => {
            if (v === "name") {
                return (a.name || "").localeCompare(b.name || "");
            } else if (v === "age") {
                const an = (typeof a.age === "number") ? a.age : -1;
                const bn = (typeof b.age === "number") ? b.age : -1;
                return an - bn;
            }
            return 0;
        });

        renderTable(sorted);
        bindRowClicks();
    };

    searchBox.addEventListener("keyup", applyFilterAndSort);
    sortBox.addEventListener("change", applyFilterAndSort);

    addDriverBtn.addEventListener("click", () => {
      location.href = "driver_add.html";
    });

</script>
</html>







