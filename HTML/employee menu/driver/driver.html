<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ドライバー運行画面</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { margin:0; background:#f8fafc; font-family:system-ui, -apple-system, "Noto Sans JP", sans-serif; }
  header { background:#0f172a; color:white; padding:10px; text-align:center; font-weight:bold; }
  main { padding:10px; display:grid; gap:12px; }
  .card { background:white; border-radius:14px; padding:12px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
  select, button { width:100%; padding:14px; font-size:18px; border-radius:12px; border:1px solid #ccc; }
  button.primary { background:#2563eb; color:white; border:none; }
  button.danger { background:#ef4444; color:white; border:none; }
  #map { height:55vh; border-radius:12px; }
  .hidden { display:none; }
  .stopDisplay { font-size:20px; text-align:center; font-weight:bold; margin:10px 0; }
  .navButtons { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
</style>
</head>
<body>

<header>ドライバー運行システム</header>

<main>
  <!-- 運行前UI -->
  <section id="setupSection" class="card">
    <h3>ルート選択</h3>
    <select id="routeSelect" disabled>
      <option>ルートを取得中...</option>
    </select>
    <button id="btnStart" class="primary" disabled>運行開始</button>
  </section>

  <!-- 運行中UI -->
  <section id="driveSection" class="card hidden">
    <div class="stopDisplay">
      現在地：<span id="currentStop">-</span>
    </div>
    <div class="navButtons">
      <button id="btnPrevStop">前の停留所へ</button>
      <button id="btnNextStop">次の停留所へ</button>
    </div>
    <button id="btnStop" class="danger" style="margin-top:12px;">位置情報共有停止</button>
  </section>

  <section id="mapSection" class="card">
    <div id="map"></div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, doc, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // --- Firebase設定 ---
  const firebaseConfig = {
    apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
    authDomain: "the-bus-94fe3.firebaseapp.com",
    projectId: "the-bus-94fe3",
    storageBucket: "the-bus-94fe3.firebasestorage.app",
    messagingSenderId: "782387450057",
    appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const routeSelect = document.getElementById("routeSelect");
  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const btnNextStop = document.getElementById("btnNextStop");
  const btnPrevStop = document.getElementById("btnPrevStop");
  const currentStopEl = document.getElementById("currentStop");

  const setupSection = document.getElementById("setupSection");
  const driveSection = document.getElementById("driveSection");
  const mapSection = document.getElementById("mapSection");

  let map = L.map("map").setView([35.68,139.76], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
  let marker;

  let user = null;
  let myRoutes = [];
  let activeRoute = null;
  let currentStopIndex = 0;
  let watchId = null;

  const fmtTime = d => d ? new Date(d).toLocaleTimeString("ja-JP",{hour12:false}) : "-";

  // --- Firebase匿名ログイン ---
  onAuthStateChanged(auth, async (u)=>{
    if(!u){
      await signInAnonymously(auth);
    }else{
      user = u;
      console.log("ログイン:", user.uid);
      await loadRoutes();
    }
  });

  async function loadRoutes(){
    const q1 = query(collection(db,"routes"), where("uid","==", user.uid));
    const snap = await getDocs(q1);
    myRoutes = [];
    snap.forEach(docSnap => myRoutes.push({id:docSnap.id, ...docSnap.data()}));
    refreshRouteSelect();
  }

  function refreshRouteSelect(){
    routeSelect.innerHTML="";
    if(myRoutes.length===0){
      routeSelect.innerHTML="<option>該当ルートなし</option>";
      routeSelect.disabled = true;
      return;
    }
    myRoutes.forEach(r=>{
      const opt=document.createElement("option");
      opt.value=r.id;
      opt.textContent=`${r.routeName||"(無名)"} ／ ${r.clientName||""}`;
      routeSelect.appendChild(opt);
    });
    routeSelect.disabled=false;
    btnStart.disabled=false;
  }

  routeSelect.addEventListener("change",()=>{
    const id = routeSelect.value;
    activeRoute = myRoutes.find(r=>r.id===id)||null;
  });

  // --- 位置情報更新 ---
  async function writeLive(coords){
    if(!user||!activeRoute)return;
    const {latitude,longitude,accuracy}=coords;
    const stop = activeRoute.stops?.[currentStopIndex]?.name || "-";
    await setDoc(doc(db,"livePositions",user.uid),{
      uid:user.uid,
      lat:latitude,lng:longitude,accuracy,
      routeId:activeRoute.id,
      routeName:activeRoute.routeName,
      currentStopName:stop,
      updatedAt:serverTimestamp(),
    },{merge:true});
  }

  // --- 運行開始 ---
  btnStart.onclick=()=>{
    if(!activeRoute){alert("ルートを選択してください");return;}
    setupSection.classList.add("hidden");
    driveSection.classList.remove("hidden");
    mapSection.classList.add("hidden");

    currentStopIndex = 0;
    currentStopEl.textContent = activeRoute.stops?.[0]?.name || "-";

    // 位置情報共有開始
    watchId = navigator.geolocation.watchPosition(async pos=>{
      const {latitude,longitude}=pos.coords;
      if(!marker){marker=L.marker([latitude,longitude]).addTo(map);}
      else{marker.setLatLng([latitude,longitude]);}
      await writeLive(pos.coords);
    }, err=>alert("位置取得失敗:"+err.message),
    {enableHighAccuracy:true, maximumAge:5000, timeout:15000});
  };

  // --- 前後の停留所ボタン ---
  btnNextStop.onclick=()=>{
    if(!activeRoute?.stops)return;
    if(currentStopIndex < activeRoute.stops.length-1){
      currentStopIndex++;
      currentStopEl.textContent = activeRoute.stops[currentStopIndex].name;
    }
  };
  btnPrevStop.onclick=()=>{
    if(currentStopIndex>0){
      currentStopIndex--;
      currentStopEl.textContent = activeRoute.stops[currentStopIndex].name;
    }
  };

  // --- 停止 ---
  btnStop.onclick=()=>{
    if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;}
    setupSection.classList.remove("hidden");
    driveSection.classList.add("hidden");
    mapSection.classList.remove("hidden");
  };
</script>
</body>
</html>
