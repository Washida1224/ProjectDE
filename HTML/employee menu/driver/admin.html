<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>運行ダッシュボード（Firebase+Pages）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{ --border:#e5e7eb; --hover:#eff6ff; --brand:#2563eb; --muted:#6b7280; }
  body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; margin:0; background:#f9fafb; color:#1f2937; }
  header{ background:#fff; border-bottom:1px solid var(--border); padding:12px 16px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap}
  h1{ margin:0; font-size:1.1rem; }
  .container{ display:grid; grid-template-columns:2fr 1fr; gap:10px; padding:10px; height:calc(100vh - 70px); box-sizing:border-box; }
  #map{ height:100%; width:100%; border-radius:10px; border:1px solid var(--border); }
  .card{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,0.05); display:flex; flex-direction:column; }
  .toolbar{ display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap }
  input,select,button{ padding:6px 10px; border-radius:8px; border:1px solid var(--border); font-size:14px; }
  button{ background:var(--brand); color:#fff; border:none; cursor:pointer; }
  button.ghost{ background:#fff; color:#111827; border:1px solid var(--border) }
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:8px; border-bottom:1px solid #f0f0f0; text-align:left; font-size:14px; }
  th{ color:var(--muted); }
  tr:hover{ background:var(--hover); }
  .mini{ font-size:12px; color:#6b7280 }
</style>
</head>
<body>
<header>
  <h1>運行ダッシュボード</h1>
  <div class="toolbar">
    <input id="q" type="search" placeholder="検索: メール/UID" />
    <input id="date" type="date" />
    <button id="btnShow" class="ghost">選択ドライバーのルート&距離</button>
    <span class="mini" id="distance"></span>
  </div>
  <button id="btnSave" class="ghost">この日の結果を履歴保存</button>
</header>

<main class="container">
  <section class="card">
    <div id="map"></div>
  </section>
  <section class="card">
    <div style="overflow:auto; flex:1;">
      <table>
        <thead><tr><th>メール</th><th>UID</th><th>緯度,経度</th><th>更新</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<script type="module">
  // ===== Firebase v10 =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, query, onSnapshot, orderBy, getDocs, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
    authDomain: "the-bus-94fe3.firebaseapp.com",
    projectId: "the-bus-94fe3",
    storageBucket: "the-bus-94fe3.firebasestorage.app",
    messagingSenderId: "782387450057",
    appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18",
    measurementId: "G-D9627JEYQ6"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Map
  let map = L.map('map').setView([35.68,139.76], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  const markers = new Map();
  let selectedUid = null;
  let routeLayer = null;

  function setMarker(v){
    const id = v.uid, latlng=[v.lat,v.lng];
    if(!markers.has(id)){
      const m = L.marker(latlng).addTo(map);
      m.bindPopup(`<strong>${v.email||id}</strong><br>${v.lat.toFixed(6)}, ${v.lng.toFixed(6)}<br>${new Date(v.updatedAt.seconds*1000).toLocaleString('ja-JP')}`);
      markers.set(id, m);
    }else{
      const m = markers.get(id);
      m.setLatLng(latlng);
      if(v.updatedAt?.seconds){
        m.setPopupContent(`<strong>${v.email||id}</strong><br>${v.lat.toFixed(6)}, ${v.lng.toFixed(6)}<br>${new Date(v.updatedAt.seconds*1000).toLocaleString('ja-JP')}`);
      }
    }
  }

  // livePositions を購読して一覧＆マーカー更新
  const liveCol = collection(db, "livePositions");
  onSnapshot(query(liveCol), (snap)=>{
    const q = (document.getElementById('q').value||'').toLowerCase();
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    let firstLatLng = null;

    snap.forEach(docSnap=>{
      const v = docSnap.data();
      if(!v || v.lat==null || v.lng==null) return;
      const text = `${v.email||''} ${v.uid||''}`.toLowerCase();
      if(q && !text.includes(q)) return;

      setMarker(v);
      firstLatLng ||= [v.lat, v.lng];

      const tr = document.createElement('tr');
      tr.onclick = ()=>{
        selectedUid = v.uid;
        map.setView([v.lat,v.lng], Math.max(map.getZoom(),15));
        markers.get(v.uid)?.openPopup();
      };
      tr.innerHTML = `
        <td>${v.email||''}</td>
        <td>${v.uid||''}</td>
        <td>${Number(v.lat).toFixed(6)}, ${Number(v.lng).toFixed(6)}</td>
        <td>${v.updatedAt?.seconds ? new Date(v.updatedAt.seconds*1000).toLocaleTimeString('ja-JP',{hour12:false}) : '-'}</td>
      `;
      tbody.appendChild(tr);
    });

    if(firstLatLng) map.setView(firstLatLng);
  });

  document.getElementById('q').oninput = ()=>{}; // 反映は次のsnapshotで

  // ハバーサイン
  function haversine(a,b){
    const R=6371000,toRad=d=>d*Math.PI/180;
    const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
    const s=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(s));
  }

  async function showRouteAndDistance(){
    const uid = selectedUid;
    if(!uid){ alert('一覧からドライバーを選択してください'); return; }
    const date = document.getElementById('date').value;
    if(!date){ alert('日付を選択してください'); return; }

    // JST一日範囲
    const from = new Date(`${date}T00:00:00+09:00`);
    const to   = new Date(`${date}T23:59:59.999+09:00`);

    // positions を一日分だけ取得
    const posCol = collection(db, "drivers", uid, "positions");
    const q1 = query(posCol, where('serverAt','>=', from), where('serverAt','<=', to), orderBy('serverAt','asc'));
    const snap = await getDocs(q1);

    const pts = [];
    snap.forEach(d=>{
      const x = d.data();
      if(typeof x.lat==='number' && typeof x.lng==='number'){
        // 雑な外れ値除外（必要に応じ強化）
        if(x.accuracy==null || x.accuracy<=80) pts.push({lat:x.lat, lng:x.lng});
      }
    });

    // 距離
    let distM = 0;
    for(let i=1;i<pts.length;i++) distM += haversine(pts[i-1],pts[i]);

    // ルート描画
    if(routeLayer){ routeLayer.remove(); routeLayer=null; }
    if(pts.length>=2){
      routeLayer = L.polyline(pts.map(p=>[p.lat,p.lng]), {weight:4}).addTo(map);
      map.fitBounds(routeLayer.getBounds(), {padding:[20,20]});
    }

    document.getElementById('distance').textContent =
      `選択日距離: ${ (distM/1000).toFixed(2) } km （点数: ${pts.length}）`;
  }

  document.getElementById('btnShow').onclick = showRouteAndDistance;
</script>
</body>
</html>

