<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ドライバー追加</title>
  <link rel="stylesheet" href="../../CSS/layout-staff.css" />
  <link rel="stylesheet" href="../../CSS/driver-list.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .add-container {
      max-width: 600px;
      margin: 40px auto;
      background: #f9f9f9;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .add-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #00796b;
    }
    form label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    form input[type="file"] {
      padding: 4px;
    }
    .btn-area {
      text-align: center;
      margin-top: 20px;
    }
    .btn-submit {
      background-color: #00796b;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-submit:hover {
      background-color: #005f55;
    }
    .preview {
      text-align: center;
      margin-top: 15px;
    }
    .preview img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #ccc;
    }
    .small-note {
      font-size: 0.8rem;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="navbar">
      <div class="logo">運行管理システム：ドライバー追加</div>
      <nav class="nav-links" id="navLinks">
        <a href="driver-list.html"><i class="fas fa-list"></i> 一覧へ戻る</a>
      </nav>
    </div>
  </header>

  <div class="add-container">
    <h2>新規ドライバー登録</h2>
    <form id="driverForm">
      <!-- ★変更：名前入力 → accounts から選択 -->
      <label>名前（ドライバーアカウントを選択）</label>
      <select id="nameSelect" required>
        <option value="">（accounts の driver アカウントから選択してください）</option>
      </select>
      <div class="small-note">
        accounts コレクションのうち、<code>userType == "driver"</code> で、まだドライバー情報に uid が登録されていないアカウントだけ表示しています。
      </div>
      <!-- ここまで名前 -->

      <label>生年月日</label>
      <input type="date" id="birthDate" required>

      <label>所属</label>
      <input type="text" id="organization" placeholder="例：東京営業所">

      <label>電話番号</label>
      <input type="tel" id="phone" placeholder="例：03-0000-0000">

      <label>住所</label>
      <input type="text" id="address" placeholder="例：東京都千代田区...">

      <label>健康状態メモ</label>
      <textarea id="healthSummary" rows="2" placeholder="例：良好"></textarea>

      <label>免許種類（複数可）</label>
      <select id="licenseTypes" multiple size="3">
        <option value="大型二種">大型二種</option>
        <option value="中型二種">中型二種</option>
        <option value="普通一種">普通一種</option>
      </select>

      <label>顔写真</label>
      <input type="file" id="photo" accept="image/*" />
      <div class="preview" id="preview"></div>

      <div class="btn-area">
        <button type="submit" class="btn-submit">登録</button>
      </div>
    </form>
  </div>

  <footer>
    <p>© 2025 プロジェクト演習D,E：A08 | All Rights Reserved</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      serverTimestamp,
      getDocs,       // ★追加
      query,         // ★追加
      where          // ★追加
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyC7AK6I_KmkFEZIaWJokO5HN1UnejpHZ3U",
      authDomain: "the-bus-94fe3.firebaseapp.com",
      projectId: "the-bus-94fe3",
      storageBucket: "the-bus-94fe3.appspot.com",
      messagingSenderId: "782387450057",
      appId: "1:782387450057:web:d6d4dcf0fd778ff6533d18"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app, "gs://the-bus-94fe3");

    const photoInput = document.getElementById("photo");
    const preview = document.getElementById("preview");
    const nameSelect = document.getElementById("nameSelect"); // ★追加
    let photoFile = null;

    // ★追加：accounts / drivers から「未リンクの driver アカウント」を読み込む
    async function loadDriverAccountOptions() {
      try {
        // accounts: userType == "driver"
        const accountsRef = collection(db, "accounts");
        const qAccounts = query(accountsRef, where("userType", "==", "driver"));
        const accountsSnap = await getDocs(qAccounts);

        // drivers: uid フィールドが存在するものの uid を集める
        const driversRef = collection(db, "drivers");
        const driversSnap = await getDocs(driversRef);
        const usedUids = new Set();
        driversSnap.forEach(d => {
          const data = d.data();
          if (data.uid) {
            usedUids.add(data.uid);
          }
        });

        // セレクト初期化
        nameSelect.innerHTML = '<option value="">（accounts の driver アカウントから選択してください）</option>';

        accountsSnap.forEach(docSnap => {
          const data = docSnap.data();
          if (!data.uid) return;               // accounts 側に uid が無いものはスキップ
          if (usedUids.has(data.uid)) return;  // すでに drivers に uid が登録されている人は除外

          const opt = document.createElement("option");
          opt.value = data.uid;                              // value に uid
          opt.textContent = data.name || data.email || data.uid; // 表示名
          nameSelect.appendChild(opt);
        });

      } catch (err) {
        console.error("ドライバーアカウント一覧の取得に失敗:", err);
        alert("ドライバーアカウント一覧の取得に失敗しました。");
      }
    }

    // ページ読み込み時に候補を読み込む
    loadDriverAccountOptions();

    photoInput.addEventListener("change", e => {
      photoFile = e.target.files[0];
      if (photoFile) {
        const reader = new FileReader();
        reader.onload = () => {
          preview.innerHTML = `<img src="${reader.result}" alt="preview">`;
        };
        reader.readAsDataURL(photoFile);
      } else {
        preview.innerHTML = "";
      }
    });

    // 登録処理
    document.getElementById("driverForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      // ★変更：name はセレクトから取得し、同時に uid も取得
      const nameSelectEl = document.getElementById("nameSelect");
      const selectedUid = nameSelectEl.value;
      const selectedName =
        nameSelectEl.options[nameSelectEl.selectedIndex]?.textContent || "";

      if (!selectedUid) {
        alert("ドライバーアカウントを選択してください。");
        return;
      }

      const name = selectedName;  // 既存コードとの互換のため name 変数に代入

      const birthDate = document.getElementById("birthDate").value;
      const organization = document.getElementById("organization").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      const healthSummary = document.getElementById("healthSummary").value.trim();
      const licenseTypes = Array.from(document.getElementById("licenseTypes").selectedOptions).map(o => o.value);

      if (!name || !birthDate) {
        alert("名前と生年月日は必須です。");
        return;
      }

      const driverId = "DRV" + Date.now();

      let photoUrl = null;
      if (photoFile) {
        try {
          const storageRef = ref(storage, `drivers/${driverId}.jpg`);
          await uploadBytes(storageRef, photoFile);
          photoUrl = await getDownloadURL(storageRef);
        } catch (err) {
          console.error("画像アップロード失敗:", err);
          alert("画像のアップロードに失敗しました。");
        }
      }

      // ★変更：newDoc に uid を追加
      const newDoc = {
        driverId,
        uid: selectedUid,   // ← accounts の uid を紐付け
        name,
        birthDate: new Date(birthDate),
        organization,
        phone,
        address,
        healthSummary,
        licenseTypes,
        photoUrl,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      };

      try {
        await setDoc(doc(collection(db, "drivers"), driverId), newDoc);
        alert("登録が完了しました。");
        // 登録後、再度候補を読み込み（同じアカウントを選べないようにする）
        await loadDriverAccountOptions();
      } catch (err) {
        console.error(err);
        alert("登録に失敗しました。");
      }
    });
  </script>
</body>
</html>
