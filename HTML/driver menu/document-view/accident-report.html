<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>事故報告書</title>
    <link rel="stylesheet" href="accident-report.css">
</head>
<body>

<div class="form-container">
    <h1 class="form-title">事故報告書</h1>

    <form id="accidentForm" class="grid-form">

        <!-- 識別用 -->
        <input type="hidden" name="formType" value="accidentReport">

        <!-- 発生日付 -->
        <div class="grid-cell label-cell" style="grid-column: 3 / span 4; grid-row: 2;">発生日付</div>
        <div class="grid-cell input-cell" style="grid-column: 7 / span 14; grid-row: 2;">
            <input type="number" name="C5" style="width:5em;"> 年
            <input type="number" name="E5" style="width:4em;"> 月
            <input type="number" name="G5" style="width:4em;"> 日
        </div>

        <!-- 報告者氏名 / 天候 -->
        <div class="grid-cell label-cell" style="grid-column: 1 / span 4; grid-row: 3;">報告者氏名</div>
        <div class="grid-cell input-cell" style="grid-column: 5 / span 7; grid-row: 3;">
            <input type="text" name="B6">
        </div>

        <div class="grid-cell label-cell" style="grid-column: 12 / span 4; grid-row: 3;">天候</div>
        <div class="grid-cell input-cell" style="grid-column: 16 / span 8; grid-row: 3;">
            <input type="text" name="D6">
        </div>

        <!-- 車両番号 / 発生場所 -->
        <div class="grid-cell label-cell" style="grid-column: 1 / span 4; grid-row: 4;">車両番号</div>
        <div class="grid-cell input-cell" style="grid-column: 5 / span 7; grid-row: 4;">
            <input type="text" name="B7">
        </div>

        <div class="grid-cell label-cell" style="grid-column: 12 / span 4; grid-row: 4;">発生場所</div>
        <div class="grid-cell input-cell" style="grid-column: 16 / span 8; grid-row: 4;">
            <input type="text" name="D7">
        </div>

        <!-- タイトル -->
        <div class="grid-cell section-title section-danger" style="grid-column: 1 / -1; grid-row: 5;">
            事故相手（存在した場合）
        </div>

        <!-- 氏名 / 住所 / 電話番号 / 勤務先 -->
        <div class="grid-cell label-cell danger-text" style="grid-column: 1 / span 4; grid-row: 6;">氏名</div>
        <div class="grid-cell input-cell" style="grid-column: 5 / span 7; grid-row: 6;">
            <input type="text" name="B9">
        </div>

        <div class="grid-cell label-cell danger-text" style="grid-column: 12 / span 4; grid-row: 6;">住所</div>
        <div class="grid-cell input-cell" style="grid-column: 16 / span 8; grid-row: 6;">
            <input type="text" name="D9">
        </div>

        <div class="grid-cell label-cell danger-text" style="grid-column: 1 / span 4; grid-row: 7;">電話番号</div>
        <div class="grid-cell input-cell" style="grid-column: 5 / span 7; grid-row: 7;">
            <input type="tel" name="B10">
        </div>

        <div class="grid-cell label-cell danger-text" style="grid-column: 12 / span 4; grid-row: 7;">勤務先</div>
        <div class="grid-cell input-cell" style="grid-column: 16 / span 8; grid-row: 7;">
            <input type="text" name="D10">
        </div>

        <!-- 事故の内容 -->
        <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 8;">事故の内容</div>
        <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 9 / span 3;">
            <textarea name="A12" rows="4"></textarea>
        </div>

        <!-- 発生原因 -->
        <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 12;">発生原因</div>
        <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 13 / span 3;">
            <textarea name="A14" rows="4"></textarea>
        </div>

        <!-- 被害状況 -->
        <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 16;">被害状況</div>
        <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 17 / span 3;">
            <textarea name="A16" rows="4"></textarea>
        </div>

        <!-- 対応策 -->
        <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 20;">対応策</div>
        <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 21 / span 3;">
            <textarea name="A18" rows="4"></textarea>
        </div>

        <!-- 再発防止策 -->
        <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 24;">再発防止策</div>
        <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 25 / span 3;">
            <textarea name="A20" rows="4"></textarea>
        </div>

        <!-- 反省 -->
        <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 28;">反省</div>
        <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 29 / span 3;">
            <textarea name="A22" rows="4"></textarea>
        </div>

        <!-- 備考欄 -->
        <div class="grid-cell section-title" style="grid-column: 1 / -1; grid-row: 32;">備考欄</div>
        <div class="grid-cell input-cell" style="grid-column: 1 / -1; grid-row: 33 / span 3;">
            <textarea name="A24" rows="4"></textarea>
        </div>

        <!-- 送信ボタン -->
        <div class="grid-cell" style="grid-column: 1 / -1; grid-row: 37; text-align: center;">
            <button type="submit" class="submit-button">報告書を作成して送信</button>
        </div>

    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzi-jK4YZegKRSGhrSuocrjLQO9TIiWapwKCM6R57eVqpbnT0TfJ7UpkP8SKRWCveUAzg/exec';

  const form = document.getElementById('accidentForm');
  const submitBtn = form.querySelector('.submit-button');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = collectPayloadFromForm(form); //

    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '送信中...';

    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      let result;
      try {
        result = JSON.parse(text);
      } catch (e) {
        console.error('JSON parse error:', text);
        result = { success: false, error: 'サーバーからJSONで返ってきませんでした', raw: text };
      }

      console.log('GAS result:', result);

      if (res.ok && result && result.success && result.fileUrlExcel) {
        window.location.href = result.fileUrlExcel;
      } else {
        const msg =
          (result && (result.error || result.message || result.raw)) ||
          `HTTP ${res.status}`;
        alert('事故報告書の作成に失敗しました：\n' + msg);
      }
    } catch (err) {
      console.error(err);
      alert('通信エラーが発生しました：\n' + String(err));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  function collectPayloadFromForm(formEl) {
    const data = {};
    const elements = formEl.querySelectorAll('input, select, textarea');

    elements.forEach((el) => {
      const name = el.name && el.name.trim();
      if (!name) return;

      if (!/^[A-Z]+[0-9]+$/.test(name)) return;

      if (el.type === 'checkbox') {
        data[name] = el.checked ? '✓' : '';
      } else {
        data[name] = el.value ?? '';
      }
    });

    return data;
  }
});
</script>

</body>
</html>
